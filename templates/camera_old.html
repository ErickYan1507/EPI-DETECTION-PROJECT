{% extends "base.html" %}

{% block title %}Flux Caméra - Détection EPI{% endblock %}

{% block content %}
<div class="camera-container" style="padding: 30px 20px; max-width: 1400px; margin: 0 auto;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <h1 style="font-size: 2em; margin: 0; background: linear-gradient(135deg, #8B1538 0%, #4169E1 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
            <i class="fas fa-video"></i> Détection en Temps Réel
        </h1>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="startBtn" onclick="startCamera()" style="padding: 10px 20px; border: none; border-radius: 8px; background: #27ae60; color: white; cursor: pointer; font-weight: bold;">
                <i class="fas fa-play"></i> Démarrer
            </button>
            <button id="stopBtn" onclick="stopCamera()" disabled style="padding: 10px 20px; border: none; border-radius: 8px; background: #e74c3c; color: white; cursor: pointer; font-weight: bold;">
                <i class="fas fa-stop"></i> Arrêter
            </button>
            <button onclick="captureFrame()" style="padding: 10px 20px; border: none; border-radius: 8px; background: #3498db; color: white; cursor: pointer; font-weight: bold;">
                <i class="fas fa-camera"></i> Capturer
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px; margin-bottom: 30px;">
        <!-- Video Stream -->
        <div class="glass-dark" style="padding: 0; border-radius: 16px; overflow: hidden; position: relative; min-height: 500px;">
            <img id="videoStream" src="" alt="Flux caméra" style="width: 100%; height: auto; display: none; background: #000;">
            <canvas id="videoCanvas" style="width: 100%; display: none; background: #000;"></canvas>
            <div id="noStream" style="display: flex; align-items: center; justify-content: center; height: 500px; background: linear-gradient(135deg, #1F2937 0%, #374151 100%); color: #999;">
                <div style="text-align: center;">
                    <i class="fas fa-video" style="font-size: 3em; margin-bottom: 20px;"></i>
                    <p>Cliquez sur "Démarrer" pour commencer la détection</p>
                </div>
            </div>
            <div id="streamStatus" style="position: absolute; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.7); color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.9em;">
                <span id="statusText">Arrêtée</span> • FPS: <span id="fpsCounter">0</span>
            </div>
        </div>

        <!-- Stats Panel -->
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Conformité -->
            <div class="glass-dark" style="padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="color: #ccc; font-size: 0.9em; margin-bottom: 10px;">
                    <i class="fas fa-shield-alt"></i> Conformité
                </div>
                <div style="font-size: 2.5em; font-weight: bold; color: #8B1538;" id="complianceValue">--</div>
                <div style="font-size: 0.8em; color: #aaa; margin-top: 8px;">
                    <div id="complianceBar" style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 5px;">
                        <div style="height: 100%; width: 0%; background: #27ae60; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>

            <!-- Personnes -->
            <div class="glass-dark" style="padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="color: #ccc; font-size: 0.9em; margin-bottom: 10px;">
                    <i class="fas fa-users"></i> Personnes
                </div>
                <div style="font-size: 2.5em; font-weight: bold; color: #4169E1;" id="personCount">--</div>
            </div>

            <!-- EPI Détectés -->
            <div class="glass-dark" style="padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="color: #ccc; font-size: 0.9em; margin-bottom: 10px;">
                    <i class="fas fa-hard-hat"></i> EPI
                </div>
                <div style="font-size: 0.9em; line-height: 2;">
                    <div><i class="fas fa-check-circle" style="color: #27ae60;"></i> Casques: <span id="helmetCount">0</span></div>
                    <div><i class="fas fa-check-circle" style="color: #3498db;"></i> Gilets: <span id="vestCount">0</span></div>
                    <div><i class="fas fa-check-circle" style="color: #f39c12;"></i> Lunettes: <span id="glassesCount">0</span></div>
                </div>
            </div>

            <!-- Alertes -->
            <div class="glass-dark" style="padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="color: #ccc; font-size: 0.9em; margin-bottom: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> Alertes
                </div>
                <div id="alertBadge" style="display: inline-block; background: #27ae60; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9em;">
                    OK
                </div>
            </div>
        </div>
    </div>

    <!-- Détections Log -->
    <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
        <h3 style="color: #fff; margin-top: 0; margin-bottom: 15px;">
            <i class="fas fa-list"></i> Historique des Détections
        </h3>
        <div id="detectionsLog" style="max-height: 300px; overflow-y: auto;">
            <div style="text-align: center; color: #888; padding: 20px;">
                Aucune détection
            </div>
        </div>
    </div>
</div>

<script>
let isStreaming = false;
let frameCount = 0;
let lastFrameTime = Date.now();
let detections = [];

function startCamera() {
    fetch('/api/camera/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({camera_index: 0})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            isStreaming = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('statusText').textContent = 'En direct';
            document.getElementById('noStream').style.display = 'none';
            document.getElementById('videoStream').style.display = 'block';
            startStreamUpdate();
        } else {
            alert('Erreur: ' + (data.error || 'Impossible de démarrer la caméra'));
        }
    })
    .catch(err => alert('Erreur: ' + err));
}

function stopCamera() {
    fetch('/api/camera/stop', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(() => {
        isStreaming = false;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('statusText').textContent = 'Arrêtée';
        document.getElementById('noStream').style.display = 'flex';
        document.getElementById('videoStream').style.display = 'none';
    });
}

function startStreamUpdate() {
    if (!isStreaming) return;
    
    document.getElementById('videoStream').src = `/api/camera/stream?t=${Math.random()}`;
    
    setInterval(() => {
        if (isStreaming) {
            fetchDetections();
        }
    }, 1000);
}

function fetchDetections() {
    fetch('/api/camera/detect')
        .then(r => r.json())
        .then(data => {
            if (data.statistics) {
                const stats = data.statistics;
                
                document.getElementById('complianceValue').textContent = Math.round(stats.compliance_rate) + '%';
                document.getElementById('personCount').textContent = stats.total_persons;
                document.getElementById('helmetCount').textContent = stats.with_helmet;
                document.getElementById('vestCount').textContent = stats.with_vest;
                document.getElementById('glassesCount').textContent = stats.with_glasses;
                
                const compliancePercent = stats.compliance_rate;
                document.querySelector('#complianceBar div').style.width = compliancePercent + '%';
                
                const alertBadge = document.getElementById('alertBadge');
                if (compliancePercent >= 80) {
                    alertBadge.textContent = 'OK';
                    alertBadge.style.background = '#27ae60';
                } else if (compliancePercent >= 50) {
                    alertBadge.textContent = 'ATTENTION';
                    alertBadge.style.background = '#f39c12';
                } else {
                    alertBadge.textContent = 'CRITIQUE';
                    alertBadge.style.background = '#e74c3c';
                }
                
                frameCount++;
                const now = Date.now();
                const elapsed = (now - lastFrameTime) / 1000;
                if (elapsed >= 1) {
                    document.getElementById('fpsCounter').textContent = Math.round(frameCount / elapsed);
                    frameCount = 0;
                    lastFrameTime = now;
                }
                
                if (data.detections && data.detections.length > 0) {
                    addToLog(data.detections[0]);
                }
            }
        })
        .catch(err => console.log('Erreur détections:', err));
}

function addToLog(detection) {
    const log = document.getElementById('detectionsLog');
    if (log.children.length === 1 && log.children[0].textContent.includes('Aucune')) {
        log.innerHTML = '';
    }
    
    const entry = document.createElement('div');
    entry.style.cssText = 'padding: 10px; background: rgba(255,255,255,0.05); border-left: 3px solid #8B1538; border-radius: 4px; margin-bottom: 8px; font-size: 0.9em;';
    entry.innerHTML = `
        <div><strong>${detection.class}</strong> - Confiance: ${(detection.confidence * 100).toFixed(0)}%</div>
        <div style="color: #999; font-size: 0.85em;">${new Date().toLocaleTimeString()}</div>
    `;
    
    log.insertBefore(entry, log.firstChild);
    
    if (log.children.length > 20) {
        log.removeChild(log.lastChild);
    }
}

function captureFrame() {
    fetch('/api/camera/frame')
        .then(r => r.blob())
        .then(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `capture_${Date.now()}.jpg`;
            a.click();
            URL.revokeObjectURL(url);
        });
}
</script>

<style>
.camera-container {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    min-height: 100vh;
}

#detectionsLog::-webkit-scrollbar {
    width: 6px;
}

#detectionsLog::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
    border-radius: 3px;
}

#detectionsLog::-webkit-scrollbar-thumb {
    background: rgba(139, 21, 56, 0.5);
    border-radius: 3px;
}

#detectionsLog::-webkit-scrollbar-thumb:hover {
    background: rgba(139, 21, 56, 0.8);
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}
