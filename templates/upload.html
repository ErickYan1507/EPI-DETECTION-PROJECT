{% extends "base.html" %}

{% block title %}D√©tection EPI - T√©l√©chargement et Analyse Modernes{% endblock %}

{% block content %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container-main {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    /* ========== HEADER ========== */
    .header-section {
        text-align: center;
        color: white;
        margin-bottom: 50px;
    }

    .header-section h1 {
        font-size: 3.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header-section p {
        font-size: 1.2em;
        opacity: 0.9;
    }

    /* ========== UPLOAD AREA ========== */
    .upload-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
    }

    .upload-box {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        backdrop-filter: blur(10px);
    }

    .upload-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 60px 30px;
        background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%);
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .upload-label:hover {
        border-color: #764ba2;
        background: linear-gradient(135deg, rgba(102,126,234,0.15) 0%, rgba(118,75,162,0.15) 100%);
        transform: translateY(-5px);
    }

    .upload-label.dragover {
        border-color: #764ba2;
        background: linear-gradient(135deg, rgba(102,126,234,0.25) 0%, rgba(118,75,162,0.25) 100%);
        transform: scale(1.03);
    }

    .upload-icon {
        font-size: 4em;
        color: #667eea;
        margin-bottom: 15px;
    }

    .upload-label h3 {
        font-size: 1.5em;
        color: #333;
        margin-bottom: 10px;
    }

    .upload-label p {
        color: #666;
        font-size: 0.95em;
    }

    #fileInput {
        display: none;
    }

    .preview-box {
        border-radius: 15px;
        overflow: hidden;
        background: #f8f9ff;
        display: none;
        position: relative;
    }

    .preview-box.show {
        display: block;
    }

    .preview-image {
        width: 100%;
        height: 300px;
        object-fit: cover;
    }

    .preview-info {
        padding: 15px;
        background: white;
        border-top: 1px solid #eee;
    }

    .preview-filename {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }

    .preview-size {
        color: #999;
        font-size: 0.9em;
    }

    /* ========== BUTTON SECTION ========== */
    .button-section {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .btn {
        flex: 1;
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102,126,234,0.4);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #f0f0f0;
        color: #333;
    }

    .btn-secondary:hover {
        background: #e0e0e0;
    }

    /* ========== LOADING SPINNER ========== */
    .loading-container {
        display: none;
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        margin: 40px 0;
    }

    .loading-container.active {
        display: block;
    }

    .spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 20px;
        border: 4px solid #f0f0f0;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ========== ALERT ========== */
    .alert-message {
        display: none;
        padding: 20px 30px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 600;
        animation: slideIn 0.3s ease;
    }

    .alert-message.show {
        display: block;
    }

    .alert-success {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border-left: 5px solid #388E3C;
    }

    .alert-error {
        background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
        color: white;
        border-left: 5px solid #C62828;
    }

    @keyframes slideIn {
        from {
            transform: translateX(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* ========== RESULTS SECTION ========== */
    .results-section {
        display: none;
        animation: fadeIn 0.5s ease;
    }

    .results-section.show {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .results-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        margin-bottom: 30px;
    }

    .results-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
    }

    .results-header-icon {
        font-size: 2.5em;
        color: #667eea;
    }

    .results-header h2 {
        color: #333;
        font-size: 2em;
    }

    /* ========== IMAGE WITH DETECTIONS ========== */
    .detection-image-wrapper {
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 30px;
        background: #f8f9ff;
    }

    .detection-image {
        width: 100%;
        display: block;
        max-height: 500px;
        object-fit: contain;
    }

    /* ========== DETECTIONS LIST ========== */
    .detections-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 30px;
    }

    .detection-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 20px;
        color: white;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .detection-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(102,126,234,0.4);
    }

    .detection-class {
        font-size: 1.3em;
        font-weight: 700;
        margin-bottom: 10px;
        text-transform: capitalize;
    }

    .detection-confidence {
        font-size: 2em;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .confidence-label {
        font-size: 0.85em;
        opacity: 0.9;
    }

    /* ========== STATISTICS ========== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .stat-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        border-left: 5px solid #667eea;
    }

    .stat-value {
        font-size: 2.5em;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 8px;
    }

    .stat-label {
        color: #555;
        font-size: 0.95em;
        font-weight: 500;
    }

    /* ========== COMPLIANCE METER ========== */
    .compliance-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        text-align: center;
    }

    .compliance-title {
        font-size: 1.3em;
        margin-bottom: 20px;
        opacity: 0.9;
    }

    .compliance-meter {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto;
    }

    .compliance-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(#4CAF50 0deg, #4CAF50 var(--percentage), #ddd var(--percentage), #ddd 360deg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3em;
        font-weight: 700;
        position: relative;
        box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }

    .compliance-inner {
        position: absolute;
        width: 90%;
        height: 90%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3em;
        font-weight: 700;
    }

    /* ========== INTERPRETATION ========== */
    .interpretation-section {
        background: #f8f9ff;
        border-radius: 15px;
        padding: 25px;
        margin-top: 30px;
        border-left: 5px solid #667eea;
    }

    .interpretation-title {
        font-size: 1.3em;
        color: #333;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .interpretation-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .interpretation-item {
        background: white;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid;
    }

    .item-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .item-value {
        font-size: 1.5em;
        font-weight: 700;
    }

    .item-good {
        border-left-color: #4CAF50;
        color: #4CAF50;
    }

    .item-warning {
        border-left-color: #FFC107;
        color: #F9A825;
    }

    .item-danger {
        border-left-color: #f44336;
        color: #f44336;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .upload-wrapper {
            grid-template-columns: 1fr;
        }

        .header-section h1 {
            font-size: 2.5em;
        }

        .container-main {
            padding: 20px 10px;
        }
    }
</style>

<div class="container-main">
    <!-- HEADER -->
    <div class="header-section">
        <h1><i class="fas fa-microscope"></i> D√©tection EPI Pro</h1>
        <p>D√©tection et Analyse Avanc√©es avec Visualisation Moderne</p>
    </div>

    <!-- ALERT MESSAGE -->
    <div id="alertMessage" class="alert-message"></div>

    <!-- UPLOAD SECTION -->
    <div class="upload-wrapper">
        <!-- LEFT: UPLOAD AREA -->
        <div class="upload-box">
            <h3 style="margin-bottom: 20px; color: #333;"><i class="fas fa-cloud-upload-alt"></i> T√©l√©charger Image/Vid√©o</h3>
            <form id="uploadForm">
                <label for="fileInput" class="upload-label" id="uploadLabel">
                    <i class="fas fa-image upload-icon"></i>
                    <h3>Cliquez pour t√©l√©charger</h3>
                    <p>ou glissez-d√©posez</p>
                    <p style="font-size: 0.85em; margin-top: 10px; color: #999;">JPG, PNG, MP4, MOV, AVI</p>
                </label>
                <input type="file" id="fileInput" accept="image/*,video/*">
                <div class="button-section">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-bolt"></i> Analyser
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Effacer
                    </button>
                </div>
            </form>
        </div>

        <!-- RIGHT: PREVIEW AREA -->
        <div class="upload-box">
            <h3 style="margin-bottom: 20px; color: #333;"><i class="fas fa-eye"></i> Aper√ßu</h3>
            <div class="preview-box" id="previewBox">
                <img id="previewImage" class="preview-image" alt="preview">
                <div class="preview-info">
                    <div class="preview-filename" id="previewFilename"></div>
                    <div class="preview-size" id="previewSize"></div>
                </div>
            </div>
            <div style="text-align: center; padding: 60px 20px; color: #999;" id="emptyPreview">
                <i class="fas fa-file-image" style="font-size: 4em; opacity: 0.3; margin-bottom: 10px;"></i>
                <p>Aucun fichier s√©lectionn√©</p>
            </div>
        </div>
    </div>

    <!-- LOADING SPINNER -->
    <div class="loading-container" id="loadingContainer">
        <div class="spinner"></div>
        <p style="color: #667eea; font-weight: 600;">Analyse de l'image...</p>
    </div>

    <!-- RESULTS SECTION -->
    <div class="results-section" id="resultsSection">
        <div class="results-container">
            <div class="results-header">
                <i class="fas fa-check-circle results-header-icon"></i>
                <h2>R√©sultats de l'Analyse</h2>
            </div>

            <!-- COMPLIANCE METER -->
            <div class="compliance-section">
                <div class="compliance-title">Taux de Conformit√© EPI</div>
                <div class="compliance-meter">
                    <div class="compliance-circle" id="complianceMeter">
                        <div class="compliance-inner" id="complianceValue">0%</div>
                    </div>
                </div>
            </div>

            <!-- DETECTIONS IMAGE -->
            <div class="detection-image-wrapper">
                <img id="resultImage" class="detection-image" alt="detection result">
            </div>

            <!-- STATISTICS GRID -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- DETECTIONS CARDS -->
            <h3 style="color: #333; margin-top: 40px; margin-bottom: 20px;">
                <i class="fas fa-cube"></i> Classes D√©tect√©es
            </h3>
            <div class="detections-grid" id="detectionsGrid"></div>

            <!-- INTERPRETATION -->
            <div class="interpretation-section" id="interpretationSection">
                <div class="interpretation-title">
                    <i class="fas fa-lightbulb"></i> Interpr√©tation de la Conformit√© EPI
                </div>
                <div class="interpretation-content" id="interpretationContent"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const uploadLabel = document.getElementById('uploadLabel');
    const uploadForm = document.getElementById('uploadForm');
    const previewBox = document.getElementById('previewBox');
    const previewImage = document.getElementById('previewImage');
    const previewFilename = document.getElementById('previewFilename');
    const previewSize = document.getElementById('previewSize');
    const emptyPreview = document.getElementById('emptyPreview');
    const submitBtn = document.getElementById('submitBtn');
    const loadingContainer = document.getElementById('loadingContainer');
    const resultsSection = document.getElementById('resultsSection');
    const alertMessage = document.getElementById('alertMessage');

    let isProcessing = false;

    // ========== DRAG & DROP ==========
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadLabel.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadLabel.addEventListener(eventName, () => {
            uploadLabel.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadLabel.addEventListener(eventName, () => {
            uploadLabel.classList.remove('dragover');
        });
    });

    uploadLabel.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        updatePreview();
    });

    // ========== FILE SELECTION ==========
    fileInput.addEventListener('change', updatePreview);
    uploadLabel.addEventListener('click', () => fileInput.click());

    function updatePreview() {
        const file = fileInput.files[0];
        
        if (!file) {
            previewBox.style.display = 'none';
            emptyPreview.style.display = 'block';
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            previewFilename.textContent = file.name;
            previewSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
            
            previewBox.style.display = 'block';
            emptyPreview.style.display = 'none';
        };

        reader.readAsDataURL(file);
    }

    // ========== FORM SUBMISSION ==========
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isProcessing) {
            showAlert('T√©l√©chargement d√©j√† en cours', 'error');
            return;
        }

        const file = fileInput.files[0];
        if (!file) {
            showAlert('Veuillez s√©lectionner un fichier', 'error');
            return;
        }

        isProcessing = true;
        submitBtn.disabled = true;
        loadingContainer.classList.add('active');
        resultsSection.classList.remove('show');

        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', file.type.startsWith('image/') ? 'image' : 'video');

        try {
            console.log('üì§ T√©l√©chargement:', file.name);
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            console.log('‚úÖ R√©ponse:', data);

            if (data.success) {
                showAlert('‚úÖ Analyse compl√©t√©e avec succ√®s!', 'success');
                displayResults(data);
                fileInput.value = '';
                updatePreview();
            } else {
                showAlert('‚ùå ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('‚ùå Error: ' + error.message, 'error');
        } finally {
            loadingContainer.classList.remove('active');
            isProcessing = false;
            submitBtn.disabled = false;
        }
    });

    // ========== ALERT ==========
    function showAlert(message, type) {
        alertMessage.textContent = message;
        alertMessage.className = `alert-message show alert-${type}`;
        
        if (type === 'success') {
            setTimeout(() => {
                alertMessage.classList.remove('show');
            }, 5000);
        }
    }

    // ========== RESULTS DISPLAY ==========
    function displayResults(data) {
        const stats = data.statistics || {};
        
        // Compliance meter
        const compliance = Math.round(stats.compliance_rate || 0);
        const complianceValue = document.getElementById('complianceValue');
        const complianceMeter = document.getElementById('complianceMeter');
        
        complianceValue.textContent = compliance + '%';
        complianceMeter.style.setProperty('--percentage', (compliance * 3.6) + 'deg');

        // Result image
        const resultImage = document.getElementById('resultImage');
            resultImage.src = data.image_url || data.image_path || '';
        displayStats(stats);

        // Detections
        displayDetections(data.detections || []);

        // Interpretation
        displayInterpretation(stats);

        resultsSection.classList.add('show');
        setTimeout(() => {
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
    }

    function displayStats(stats) {
        const statsGrid = document.getElementById('statsGrid');
        statsGrid.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${stats.total_persons || 0}</div>
                <div class="stat-label">üë• Total Personnes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.with_helmet || 0}</div>
                <div class="stat-label">ü™ñ Avec Casque</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.with_vest || 0}</div>
                <div class="stat-label">ü¶∫ Avec Gilet</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.with_glasses || 0}</div>
                <div class="stat-label">üëì Avec Lunettes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.with_boots || 0}</div>
                <div class="stat-label">üë¢ Avec Bottes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${Math.round(stats.compliance_rate || 0)}%</div>
                <div class="stat-label">‚úÖ Conformit√©</div>
            </div>
        `;
    }

    function displayDetections(detections) {
        const detectionsGrid = document.getElementById('detectionsGrid');
        
        if (!detections || detections.length === 0) {
            detectionsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Aucune d√©tection</p>';
            return;
        }

        const colors = {
            'person': '#667eea',
            'helmet': '#4CAF50',
            'vest': '#FFC107',
            'glasses': '#2196F3',
            'boots': '#9C27B0'
        };

        detectionsGrid.innerHTML = detections.map(det => {
            const confidence = Math.round((det.confidence || 0) * 100);
            const className = det.class_name || 'unknown';
            const color = colors[className.toLowerCase()] || '#667eea';
            
            return `
                <div class="detection-card" style="background: linear-gradient(135deg, ${color} 0%, ${color}cc 100%);">
                    <div class="detection-class">${className}</div>
                    <div class="detection-confidence">${confidence}%</div>
                    <div class="confidence-label">Confidence</div>
                </div>
            `;
        }).join('');
    }

    function displayInterpretation(stats) {
        const total = stats.total_persons || 0;
        const helmet = stats.with_helmet || 0;
        const vest = stats.with_vest || 0;
        const glasses = stats.with_glasses || 0;
        const boots = stats.with_boots || 0;
        const compliance = Math.round(stats.compliance_rate || 0);

        function getStatus(percentage) {
            if (percentage >= 80) return { class: 'item-good', text: '‚úÖ Bon', emoji: '‚úÖ' };
            if (percentage >= 50) return { class: 'item-warning', text: '‚ö†Ô∏è Attention', emoji: '‚ö†Ô∏è' };
            return { class: 'item-danger', text: '‚ùå Critique', emoji: '‚ùå' };
        }

        const helmetStatus = total > 0 ? getStatus((helmet / total) * 100) : getStatus(0);
        const vestStatus = total > 0 ? getStatus((vest / total) * 100) : getStatus(0);
        const bootStatus = total > 0 ? getStatus((boots / total) * 100) : getStatus(0);

        document.getElementById('interpretationContent').innerHTML = `
            <div class="interpretation-item ${helmetStatus.class}">
                <div class="item-label">üë∑ Conformit√© Casque</div>
                <div class="item-value">${helmetStatus.emoji} ${total > 0 ? Math.round((helmet/total)*100) : 0}%</div>
            </div>
            <div class="interpretation-item ${vestStatus.class}">
                <div class="item-label">ü¶∫ Conformit√© Gilet</div>
                <div class="item-value">${vestStatus.emoji} ${total > 0 ? Math.round((vest/total)*100) : 0}%</div>
            </div>
            <div class="interpretation-item ${bootStatus.class}">
                <div class="item-label">üë¢ Conformit√© Bottes</div>
                <div class="item-value">${bootStatus.emoji} ${total > 0 ? Math.round((boots/total)*100) : 0}%</div>
            </div>
            <div class="interpretation-item ${compliance >= 80 ? 'item-good' : compliance >= 50 ? 'item-warning' : 'item-danger'}">
                <div class="item-label">üìä Score Global</div>
                <div class="item-value">${compliance >= 80 ? '‚úÖ' : compliance >= 50 ? '‚ö†Ô∏è' : '‚ùå'} ${compliance}%</div>
            </div>
        `;
    }
</script>

{% endblock %}
