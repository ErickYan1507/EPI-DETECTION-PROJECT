{% extends "base.html" %}

{% block title %}EPI Detection - Upload & Analyze{% endblock %}

{% block content %}
<style>
    .detection-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .upload-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        padding: 40px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    .upload-section h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: bold;
    }
    
    .upload-section p {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .form-card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .file-input-wrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
        width: 100%;
    }
    
    .file-input-label {
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px dashed #667eea;
        border-radius: 8px;
        padding: 40px;
        background: #f8f9ff;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .file-input-label:hover {
        border-color: #764ba2;
        background: #ede9ff;
    }
    
    .file-input-label.dragover {
        border-color: #764ba2;
        background: #e0d4ff;
        transform: scale(1.02);
    }
    
    .file-input-label i {
        font-size: 2.5rem;
        margin-right: 20px;
        color: #667eea;
    }
    
    .file-input-text h3 {
        margin: 0 0 5px 0;
        color: #333;
        font-weight: 600;
    }
    
    .file-input-text p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }
    
    #file {
        display: none;
    }
    
    .form-group-inline {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 0.95rem;
    }
    
    .form-group select,
    .form-group input[type="number"] {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: border-color 0.3s ease;
    }
    
    .form-group select:focus,
    .form-group input[type="number"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .btn-submit {
        flex: 1;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
    }
    
    .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-reset {
        background: #e0e0e0;
        color: #333;
        padding: 14px 28px;
        border-radius: 6px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-reset:hover {
        background: #d0d0d0;
    }
    
    .file-preview {
        margin-top: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 6px;
        display: none;
    }
    
    .file-preview.show {
        display: block;
    }
    
    .file-preview img,
    .file-preview video {
        max-width: 100%;
        max-height: 300px;
        border-radius: 6px;
        margin-top: 10px;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .loading-spinner.active {
        display: block;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .results-section {
        display: none;
        margin-top: 30px;
    }
    
    .results-section.show {
        display: block;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #667eea;
    }
    
    .stat-card h4 {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
    }
    
    .stat-card.helmet { border-left-color: #ff6b6b; }
    .stat-card.vest { border-left-color: #4ecdc4; }
    .stat-card.glasses { border-left-color: #45b7d1; }
    .stat-card.compliance { border-left-color: #51cf66; }
    
    .compliance-meter {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .compliance-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }
    
    .progress-bar {
        width: 100%;
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 10px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b 0%, #feca57 50%, #51cf66 100%);
        width: 0%;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.85rem;
    }
    
    .compliance-text {
        text-align: center;
        font-size: 0.9rem;
        color: #666;
    }
    
    .alert-box {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    .alert-success {
        background: #d4edda;
        border-left: 4px solid #28a745;
        color: #155724;
    }
    
    .alert-error {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        color: #721c24;
    }
    
    .alert-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404;
    }
    
    .detections-list {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .detections-list h3 {
        margin-top: 0;
        color: #333;
    }
    
    .detection-item {
        padding: 10px;
        background: #f9f9f9;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
    }
    
    .detection-class {
        font-weight: 600;
        color: #667eea;
        display: inline-block;
        background: #ede9ff;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
    }
    
    .detection-confidence {
        float: right;
        color: #666;
        font-size: 0.9rem;
    }
    
    .timing-info {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 6px;
        font-size: 0.9rem;
        color: #666;
        margin-top: 15px;
    }
    
    .timing-info strong {
        color: #333;
    }
</style>

<div class="detection-container">
    <!-- Header Section -->
    <div class="upload-section">
        <h1>üîç EPI Detection & Analysis</h1>
        <p>Detect Safety Equipment (Helmet, Vest, Glasses) in Images & Videos</p>
    </div>
    
    <!-- Upload Form -->
    <div class="form-card">
        <form id="uploadForm" enctype="multipart/form-data">
            <!-- File Upload Area -->
            <div class="file-input-wrapper">
                <label for="file" class="file-input-label" id="fileLabel">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <div class="file-input-text">
                        <h3>Click to Upload or Drag & Drop</h3>
                        <p>Support images (JPG, PNG) and videos (MP4, AVI)</p>
                    </div>
                </label>
                <input type="file" id="file" name="file" accept="image/*,video/*" required>
            </div>
            
            <!-- File Preview -->
            <div class="file-preview" id="filePreview">
                <strong>Preview:</strong>
                <div id="previewContent"></div>
            </div>
            
            <!-- Configuration Section -->
            <div class="form-group-inline">
                <div class="form-group">
                    <label for="confidence">Confidence Threshold:</label>
                    <input type="number" id="confidence" name="confidence" min="0" max="1" step="0.1" value="0.5">
                    <small style="color: #666;">Only detections with higher confidence are shown</small>
                </div>
                
                <div class="form-group">
                    <label for="iouThreshold">IOU Threshold:</label>
                    <input type="number" id="iouThreshold" name="iouThreshold" min="0" max="1" step="0.1" value="0.5">
                    <small style="color: #666;">Non-max suppression threshold</small>
                </div>
            </div>
            
            <!-- Button Group -->
            <div class="button-group">
                <button type="submit" class="btn-submit" id="submitBtn">
                    <i class="fas fa-play"></i> Analyze Now
                </button>
                <button type="reset" class="btn-reset" id="resetBtn">
                    <i class="fas fa-redo"></i> Clear
                </button>
            </div>
        </form>
        
        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>Processing your file... This may take a moment.</p>
        </div>
    </div>
    
    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
        <!-- Alert Box -->
        <div id="alertBox" class="alert-box" style="display:none;"></div>
        
        <!-- Compliance Meter -->
        <div class="compliance-meter" id="complianceMeter" style="display:none;">
            <div class="compliance-label">Safety Compliance Rate</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="compliance-text" id="complianceText"></div>
        </div>
        
        <!-- Statistics Grid -->
        <div class="stats-grid" id="statsGrid"></div>
        
        <!-- Detections List -->
        <div class="detections-list" id="detectionsList" style="display:none;">
            <h3>üìä Detailed Detections</h3>
            <div id="detectionsContent"></div>
        </div>
        
        <!-- Timing Information -->
        <div class="timing-info" id="timingInfo" style="display:none;"></div>
    </div>
</div>

<script>
// ============= File Input & Preview =============
const fileInput = document.getElementById('file');
const fileLabel = document.getElementById('fileLabel');
const filePreview = document.getElementById('filePreview');
const previewContent = document.getElementById('previewContent');

// Drag and Drop
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    fileLabel.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    fileLabel.addEventListener(eventName, () => fileLabel.classList.add('dragover'), false);
});

['dragleave', 'drop'].forEach(eventName => {
    fileLabel.addEventListener(eventName, () => fileLabel.classList.remove('dragover'), false);
});

fileLabel.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;
    fileInput.files = files;
    updatePreview();
}, false);

// Click to Select
fileLabel.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', updatePreview);

function updatePreview() {
    const file = fileInput.files[0];
    if (!file) {
        filePreview.classList.remove('show');
        return;
    }
    
    const reader = new FileReader();
    const isImage = file.type.startsWith('image/');
    const isVideo = file.type.startsWith('video/');
    
    reader.onload = (e) => {
        previewContent.innerHTML = '';
        
        if (isImage) {
            const img = document.createElement('img');
            img.src = e.target.result;
            previewContent.appendChild(img);
        } else if (isVideo) {
            const video = document.createElement('video');
            video.src = e.target.result;
            video.controls = true;
            previewContent.appendChild(video);
        }
        
        filePreview.classList.add('show');
    };
    
    reader.readAsDataURL(file);
}

// ============= Form Submission =============
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const file = fileInput.files[0];
    if (!file) {
        alert('Please select a file');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('type', file.type.startsWith('image/') ? 'image' : 'video');
    formData.append('confidence', document.getElementById('confidence').value);
    formData.append('iouThreshold', document.getElementById('iouThreshold').value);
    
    // Show loading spinner, hide results
    document.getElementById('loadingSpinner').classList.add('active');
    document.getElementById('resultsSection').classList.remove('show');
    document.getElementById('submitBtn').disabled = true;
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        displayResults(data);
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error processing file: ' + error.message, 'error');
    } finally {
        document.getElementById('loadingSpinner').classList.remove('active');
        document.getElementById('submitBtn').disabled = false;
    }
});

// ============= Results Display =============
function displayResults(data) {
    const resultsSection = document.getElementById('resultsSection');
    
    if (!data.success) {
        showAlert(data.error || 'Unknown error occurred', 'error');
        resultsSection.classList.remove('show');
        return;
    }
    
    // Show alert
    showAlert('Analysis completed successfully!', 'success');
    
    // Get statistics
    const stats = data.statistics || {};
    
    // Update compliance meter
    const complianceRate = stats.compliance_rate || 0;
    updateComplianceMeter(complianceRate, stats.compliance_level);
    
    // Update statistics cards
    updateStatsCards(stats);
    
    // Update detections list
    updateDetectionsList(data.detections || []);
    
    // Update timing info
    updateTimingInfo(stats);
    
    // Show results section
    resultsSection.classList.add('show');
}

function showAlert(message, type) {
    const alertBox = document.getElementById('alertBox');
    const alertClass = `alert-${type}`;
    
    alertBox.textContent = message;
    alertBox.className = `alert-box ${alertClass}`;
    alertBox.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 5000);
    }
}

function updateComplianceMeter(rate, level) {
    const meter = document.getElementById('complianceMeter');
    const fill = document.getElementById('progressFill');
    const text = document.getElementById('complianceText');
    
    const percentage = Math.min(100, Math.max(0, rate));
    fill.style.width = percentage + '%';
    fill.textContent = percentage.toFixed(1) + '%';
    
    let levelText = 'Non-Compliant';
    let color = '#dc3545';
    
    if (level === 'full') {
        levelText = '‚úì Full Compliance';
        color = '#28a745';
    } else if (level === 'partial') {
        levelText = '‚ö† Partial Compliance';
        color = '#ffc107';
    } else if (level === 'non-compliant') {
        levelText = '‚úó Non-Compliant';
        color = '#dc3545';
    }
    
    text.innerHTML = `<span style="color: ${color}; font-weight: 600;">${levelText}</span>`;
    meter.style.display = 'block';
}

function updateStatsCards(stats) {
    const statsGrid = document.getElementById('statsGrid');
    statsGrid.innerHTML = '';
    
    const statItems = [
        { key: 'total_persons', label: 'Total Persons', icon: 'fa-users', class: 'stat-card' },
        { key: 'with_helmet', label: 'With Helmet', icon: 'fa-hard-hat', class: 'stat-card helmet' },
        { key: 'with_vest', label: 'With Vest', icon: 'fa-vest', class: 'stat-card vest' },
        { key: 'with_glasses', label: 'With Glasses', icon: 'fa-glasses', class: 'stat-card glasses' },
        { key: 'with_boots', label: 'With Boots', icon: 'fa-shoe-prints', class: 'stat-card' }
    ];
    
    statItems.forEach(item => {
        const value = stats[item.key] || 0;
        const card = document.createElement('div');
        card.className = item.class;
        card.innerHTML = `
            <i class="fas ${item.icon}" style="font-size: 1.5rem; color: #667eea; margin-bottom: 10px;"></i>
            <h4>${item.label}</h4>
            <div class="stat-value">${value}</div>
        `;
        statsGrid.appendChild(card);
    });
    
    // Add compliance rate card
    const compCard = document.createElement('div');
    compCard.className = 'stat-card compliance';
    compCard.innerHTML = `
        <i class="fas fa-check-circle" style="font-size: 1.5rem; color: #51cf66; margin-bottom: 10px;"></i>
        <h4>Compliance Rate</h4>
        <div class="stat-value">${(stats.compliance_rate || 0).toFixed(1)}%</div>
    `;
    statsGrid.appendChild(compCard);
}

function updateDetectionsList(detections) {
    const list = document.getElementById('detectionsList');
    const content = document.getElementById('detectionsContent');
    
    if (!detections || detections.length === 0) {
        list.style.display = 'none';
        return;
    }
    
    content.innerHTML = '';
    detections.forEach((det, idx) => {
        const item = document.createElement('div');
        item.className = 'detection-item';
        
        const confidence = (det.confidence * 100).toFixed(1);
        item.innerHTML = `
            <div>
                <span class="detection-class">${det.class}</span>
                <span class="detection-confidence">Confidence: ${confidence}%</span>
            </div>
            <small style="color: #999;">Box: [${det.bbox.join(', ')}]</small>
        `;
        
        content.appendChild(item);
    });
    
    list.style.display = 'block';
}

function updateTimingInfo(stats) {
    const timingInfo = document.getElementById('timingInfo');
    const inference = (stats.inference_ms || 0).toFixed(1);
    const total = (stats.total_ms || 0).toFixed(1);
    
    timingInfo.innerHTML = `
        <strong>‚è±Ô∏è Processing Time:</strong><br>
        Inference: <strong>${inference}ms</strong> | Total: <strong>${total}ms</strong>
    `;
    timingInfo.style.display = 'block';
}

// ============= Reset Form =============
document.getElementById('resetBtn').addEventListener('click', () => {
    filePreview.classList.remove('show');
    document.getElementById('resultsSection').classList.remove('show');
    document.getElementById('alertBox').style.display = 'none';
});
</script>
{% endblock %}
