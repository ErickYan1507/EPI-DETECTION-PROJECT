{% extends "base.html" %}

{% block title %}Tableau de Bord - Détection EPI{% endblock %}

{% block content %}
<div class="dashboard-container" style="padding: 30px 20px; max-width: 1600px; margin: 0 auto;">
    <!-- En-tête -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; flex-wrap: wrap; gap: 20px;">
        <h1 style="font-size: 2.5em; margin: 0; background: linear-gradient(135deg, #8B1538 0%, #4169E1 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
            <i class="fas fa-tachometer-alt"></i> Tableau de Bord
        </h1>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="exportPDF()" class="glass" style="padding: 10px 20px; border: none; border-radius: 12px; color: #fff; cursor: pointer; backdrop-filter: blur(10px); background: rgba(139, 21, 56, 0.2);">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button onclick="refreshData()" class="glass" style="padding: 10px 20px; border: none; border-radius: 12px; color: #fff; cursor: pointer; backdrop-filter: blur(10px); background: rgba(65, 105, 225, 0.2);">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 40px; color: #8B1538;"><i class="fas fa-user-check"></i></div>
                <div style="flex: 1;">
                    <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Taux Conformité</div>
                    <div style="font-size: 2em; font-weight: bold; color: #fff;" id="complianceRate">85%</div>
                    <div style="color: #4169E1; font-size: 0.85em; margin-top: 5px;"><i class="fas fa-arrow-up"></i> 5% vs hier</div>
                </div>
            </div>
        </div>

        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 40px; color: #4169E1;"><i class="fas fa-users"></i></div>
                <div style="flex: 1;">
                    <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Personnes Détectées</div>
                    <div style="font-size: 2em; font-weight: bold; color: #fff;" id="totalPersons">24</div>
                    <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">En temps réel</div>
                </div>
            </div>
        </div>

        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 40px; color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i></div>
                <div style="flex: 1;">
                    <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Alertes Actives</div>
                    <div style="font-size: 2em; font-weight: bold; color: #fff;" id="activeAlerts">3</div>
                    <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">À traiter</div>
                </div>
            </div>
        </div>

        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 40px; color: #4db8ff;"><i class="fas fa-shield-alt"></i></div>
                <div style="flex: 1;">
                    <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Détections Aujourd'hui</div>
                    <div style="font-size: 2em; font-weight: bold; color: #fff;" id="todayDetections">156</div>
                    <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">Total journalier</div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRAPHIQUES - Première Rangée -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <!-- Graphique Courbe - Conformité Jour -->
        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); position: relative;">
            <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-line"></i> Conformité par Heure</h3>
            <canvas id="complianceChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- Graphique Histogramme - Détections par Heure -->
        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); position: relative;">
            <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-bar"></i> Détections par Heure</h3>
            <canvas id="hourlyChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- GRAPHIQUES - Deuxième Rangée -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <!-- Graphique Camembert - Répartition EPI -->
        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-pie"></i> EPI Détectés</h3>
            <canvas id="epiChart" style="max-height: 280px;"></canvas>
        </div>

        <!-- Graphique Doughnut - Alertes par Niveau -->
        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-exclamation-circle"></i> Alertes par Sévérité</h3>
            <canvas id="alertsChart" style="max-height: 280px;"></canvas>
        </div>

        <!-- Graphique Radar - Performance -->
        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-radar"></i> Performance Modèle</h3>
            <canvas id="performanceChart" style="max-height: 280px;"></canvas>
        </div>

        <!-- Graphique Surface - Cumul Détections -->
        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-area"></i> Cumul Détections</h3>
            <canvas id="cumulChart" style="max-height: 280px;"></canvas>
        </div>
    </div>

    <!-- Table des Détections Récentes -->
    <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 40px;">
        <h3 style="color: #fff; margin-top: 0;"><i class="fas fa-history"></i> Détections Récentes</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <th style="padding: 12px; text-align: left; color: #8B1538;">Heure</th>
                        <th style="padding: 12px; text-align: left; color: #8B1538;">Personnes</th>
                        <th style="padding: 12px; text-align: left; color: #8B1538;">Casques</th>
                        <th style="padding: 12px; text-align: left; color: #8B1538;">Gilets</th>
                        <th style="padding: 12px; text-align: left; color: #8B1538;">Lunettes</th>
                        <th style="padding: 12px; text-align: left; color: #8B1538;">Conformité</th>
                        <th style="padding: 12px; text-align: left; color: #8B1538;">Statut</th>
                    </tr>
                </thead>
                <tbody id="detectionsTable" style="color: #ddd;">
                    <!-- Rempli dynamiquement -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Alertes Récentes -->
    <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
        <h3 style="color: #fff; margin-top: 0;"><i class="fas fa-bell"></i> Alertes Récentes</h3>
        <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 15px;" id="alertsList">
            <!-- Rempli dynamiquement depuis API -->
            <div style="padding: 12px; border-radius: 8px; color: #aaa; text-align: center;">
                <i class="fas fa-spinner fa-spin"></i> Chargement des alertes...
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script>
let charts = {};

// Fonction de rafraîchissement des données
function refreshData() {
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            if (data.compliance_rate !== undefined) {
                document.getElementById('complianceRate').textContent = Math.round(data.compliance_rate) + '%';
                document.getElementById('totalPersons').textContent = data.total_persons || 0;
                document.getElementById('activeAlerts').textContent = data.alerts || 0;
                document.getElementById('todayDetections').textContent = data.detections_today || 0;
                console.log('Données API reçues:', data);
            }
            initCharts(data);
        })
        .catch(err => {
            console.log('Erreur API stats:', err);
            console.log('Utilisation des données de démonstration');
            initCharts();
        });
}

function initCharts(data = null) {
    Promise.all([
        fetch('/api/chart/hourly').then(r => r.json()).catch(() => ({})),
        fetch('/api/chart/epi').then(r => r.json()).catch(() => ({})),
        fetch('/api/chart/alerts').then(r => r.json()).catch(() => ({})),
        fetch('/api/chart/cumulative').then(r => r.json()).catch(() => ({}))
    ]).then(([hourlyData, epiData, alertsData, cumulData]) => {
        const demoData = data || {
            compliance_rate: 85,
            total_persons: 24,
            alerts: 3,
            detections_today: 156
        };

        updateCharts(demoData, hourlyData, epiData, alertsData, cumulData);
    });
}

function updateCharts(data, hourlyData, epiData, alertsData, cumulData) {

    const colors = {
        primary: 'rgba(139, 21, 56, 0.8)',   // Garnet
        secondary: 'rgba(65, 105, 225, 0.8)', // Royal Blue
        success: 'rgba(75, 192, 75, 0.8)',    // Green
        warning: 'rgba(255, 165, 0, 0.8)',    // Orange
        danger: 'rgba(255, 107, 107, 0.8)',   // Red
        dark: 'rgba(31, 41, 55, 0.8)'        // Dark
    };

    // 1. Graphique Courbe - Conformité
    if (charts.compliance) charts.compliance.destroy();
    const complianceLabels = hourlyData.hours || ['00h', '03h', '06h', '09h', '12h', '15h', '18h', '21h'];
    const complianceValues = hourlyData.compliance || [78, 82, 85, 88, 87, 89, 86, 85];
    
    charts.compliance = new Chart(document.getElementById('complianceChart'), {
        type: 'line',
        data: {
            labels: complianceLabels,
            datasets: [{
                label: 'Taux de Conformité (%)',
                data: complianceValues,
                borderColor: colors.primary,
                backgroundColor: 'rgba(139, 21, 56, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointBackgroundColor: colors.primary
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, max: 100, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });

    // 2. Graphique Histogramme - Détections par Heure
    if (charts.hourly) charts.hourly.destroy();
    const hourlyLabels = hourlyData.hours || ['00h', '03h', '06h', '09h', '12h', '15h', '18h', '21h'];
    const hourlyDetections = hourlyData.detections || [12, 18, 15, 22, 28, 19, 25, 21];
    
    charts.hourly = new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: {
            labels: hourlyLabels,
            datasets: [{
                label: 'Détections',
                data: hourlyDetections,
                backgroundColor: hourlyLabels.map((_, i) => i % 2 === 0 ? colors.primary : colors.secondary),
                borderColor: '#8B1538',
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });

    // 3. Graphique Camembert - EPI
    if (charts.epi) charts.epi.destroy();
    const epiLabels = ['Casques', 'Gilets', 'Lunettes'];
    const epiValues = [
        epiData.helmets || 68,
        epiData.vests || 45,
        epiData.glasses || 32
    ];
    
    charts.epi = new Chart(document.getElementById('epiChart'), {
        type: 'doughnut',
        data: {
            labels: epiLabels,
            datasets: [{
                data: epiValues,
                backgroundColor: [colors.primary, colors.secondary, 'rgba(75, 192, 75, 0.8)'],
                borderColor: '#1F2937',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { labels: { color: '#ddd' } }
            }
        }
    });

    // 4. Graphique Doughnut - Alertes
    if (charts.alerts) charts.alerts.destroy();
    const alertLabels = ['Critique', 'Moyen', 'Bas'];
    const alertValues = [
        alertsData.high || 5,
        alertsData.medium || 12,
        alertsData.low || 8
    ];
    
    charts.alerts = new Chart(document.getElementById('alertsChart'), {
        type: 'doughnut',
        data: {
            labels: alertLabels,
            datasets: [{
                data: alertValues,
                backgroundColor: ['rgba(255, 107, 107, 0.8)', 'rgba(255, 165, 0, 0.8)', 'rgba(65, 105, 225, 0.8)'],
                borderColor: '#1F2937',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { labels: { color: '#ddd' } }
            }
        }
    });

    // 5. Graphique Radar - Performance
    if (charts.performance) charts.performance.destroy();
    charts.performance = new Chart(document.getElementById('performanceChart'), {
        type: 'radar',
        data: {
            labels: ['Précision', 'Rappel', 'F1-Score', 'Spécificité', 'Sensibilité'],
            datasets: [{
                label: 'Performance Modèle',
                data: [92, 88, 90, 85, 91],
                borderColor: colors.primary,
                backgroundColor: 'rgba(139, 21, 56, 0.2)',
                pointBackgroundColor: colors.primary,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#aaa' },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                }
            },
            plugins: {
                legend: { labels: { color: '#ddd' } }
            }
        }
    });

    // 6. Graphique Surface - Cumul Détections
    if (charts.cumul) charts.cumul.destroy();
    const cumulLabels = cumulData.days || ['Jour 1', 'Jour 2', 'Jour 3', 'Jour 4', 'Jour 5', 'Jour 6', 'Jour 7'];
    const cumulValues = cumulData.cumulative || [50, 120, 180, 260, 350, 420, 485];
    
    charts.cumul = new Chart(document.getElementById('cumulChart'), {
        type: 'line',
        data: {
            labels: cumulLabels,
            datasets: [{
                label: 'Cumul Détections',
                data: cumulValues,
                borderColor: colors.secondary,
                backgroundColor: 'rgba(65, 105, 225, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: colors.secondary
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });
}

function exportPDF() {
    alert('Export PDF - Fonctionnalité en développement');
}

function loadDetections() {
    fetch('/api/realtime?limit=10')
        .then(r => r.json())
        .then(data => {
            const table = document.getElementById('detectionsTable');
            table.innerHTML = '';
            
            console.log('Données realtime reçues:', data); // Debug
            
            if (data.full_data && data.full_data.length > 0) {
                for (let i = 0; i < data.full_data.length && i < 10; i++) {
                    const det = data.full_data[i];
                    
                    // Convertir timestamp ISO en heure locale
                    const localTime = new Date(det.timestamp).toLocaleTimeString('fr-FR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                    row.innerHTML = `
                        <td style="padding: 12px;">${localTime}</td>
                        <td style="padding: 12px;">${det.total_persons || 0}</td>
                        <td style="padding: 12px;">${det.with_helmet || 0}</td>
                        <td style="padding: 12px;">${det.with_vest || 0}</td>
                        <td style="padding: 12px;">${det.with_glasses || 0}</td>
                        <td style="padding: 12px;">${Math.round(det.compliance_rate) || 0}%</td>
                        <td style="padding: 12px;">
                            <span style="background: ${det.compliance_rate >= 80 ? '#27ae60' : '#e74c3c'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">
                                ${det.compliance_rate >= 80 ? 'OK' : 'ALERT'}
                            </span>
                        </td>
                    `;
                    table.appendChild(row);
                }
            } else {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" style="padding: 20px; text-align: center; color: #aaa;">Aucune détection</td>';
                table.appendChild(row);
            }
        })
        .catch(err => {
            console.error('Erreur chargement détections:', err);
            const table = document.getElementById('detectionsTable');
            table.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #ff6b6b;">Erreur chargement</td></tr>';
        });
}

function loadAlerts() {
    fetch('/api/alerts-recent?limit=10')
        .then(r => r.json())
        .then(data => {
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = '';
            
            if (!data.alerts || data.alerts.length === 0) {
                alertsList.innerHTML = '<div style="padding: 12px; border-radius: 8px; color: #aaa; text-align: center;">Aucune alerte</div>';
                return;
            }
            
            // Couleurs par sévérité
            const severityColors = {
                'critical': { border: '#ff6b6b', bg: 'rgba(255, 107, 107, 0.1)', icon: 'exclamation-circle' },
                'high': { border: '#ff6b6b', bg: 'rgba(255, 107, 107, 0.1)', icon: 'exclamation-circle' },
                'medium': { border: '#ffa500', bg: 'rgba(255, 165, 0, 0.1)', icon: 'exclamation-triangle' },
                'warning': { border: '#ffa500', bg: 'rgba(255, 165, 0, 0.1)', icon: 'exclamation-triangle' },
                'low': { border: '#4169E1', bg: 'rgba(65, 105, 225, 0.1)', icon: 'info-circle' }
            };
            
            data.alerts.forEach(alert => {
                const colors = severityColors[alert.severity] || severityColors['low'];
                const alertDiv = document.createElement('div');
                alertDiv.style.cssText = `padding: 12px; border-left: 4px solid ${colors.border}; background: ${colors.bg}; border-radius: 8px;`;
                alertDiv.innerHTML = `
                    <div style="color: #fff;"><i class="fas fa-${colors.icon}"></i> ${alert.message}</div>
                    <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">${alert.time_ago}</div>
                `;
                alertsList.appendChild(alertDiv);
            });
        })
        .catch(err => {
            console.log('Erreur chargement alertes:', err);
            document.getElementById('alertsList').innerHTML = '<div style="padding: 12px; border-radius: 8px; color: #aaa; text-align: center;">Erreur chargement</div>';
        });
}

// Fonction d'export PDF
function exportPDF() {
    // Demander les dates à l'utilisateur
    const startDate = prompt('Date de début (YYYY-MM-DD) ou laissez vide pour 7 derniers jours:', '');
    const endDate = prompt('Date de fin (YYYY-MM-DD) ou laissez vide pour aujourd\'hui:', '');
    
    // Construire l'URL
    let url = '/api/export/detection-pdf';
    const params = [];
    
    if (startDate) params.push(`start_date=${startDate}`);
    if (endDate) params.push(`end_date=${endDate}`);
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    // Ouvrir dans un nouvel onglet pour déclencher le téléchargement
    window.open(url, '_blank');
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
    refreshData();
    loadDetections();
    loadAlerts();
    setInterval(refreshData, 5000); // Rafraîchir tous les 5s pour données plus en direct
    setInterval(loadDetections, 3000); // Charger les détections tous les 3s pour temps quasi-réel
    setInterval(loadAlerts, 3000); // Charger les alertes tous les 3s pour temps quasi-réel
});
</script>
{% endblock %}