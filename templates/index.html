{% extends "base.html" %}

{% block title %}Accueil - Syst√®me de D√©tection EPI{% endblock %}

{% block content %}
<div style="padding: 40px 20px; max-width: 1600px; margin: 0 auto;">
    <!-- Hero Section -->
    <div style="text-align: center; margin-bottom: 40px; position: relative; z-index: 1;">
        <h1 style="font-size: 3.5em; margin: 0 0 20px 0; line-height: 1.2;">
            <span style="background: linear-gradient(135deg, #8B1538 0%, #4169E1 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                <i class="fas fa-hard-hat"></i> D√©tection Intelligente d'EPI
            </span>
        </h1>
        <p style="font-size: 1.3em; color: #aaa; margin: 20px 0; max-width: 600px; margin-left: auto; margin-right: auto;">
            Surveillance automatique des √âquipements de Protection Individuelle par Intelligence Artificielle en temps r√©el
        </p>
    </div>

    <!-- Dashboard Content - Tableau de Bord -->
    <div class="dashboard-container" style="padding: 0; max-width: 1600px; margin: 0 auto;">
        <!-- En-t√™te Dashboard -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; flex-wrap: wrap; gap: 20px;">
            <div>
                <h2 style="font-size: 2.5em; margin: 0; background: linear-gradient(135deg, #8B1538 0%, #4169E1 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    <i class="fas fa-tachometer-alt"></i> Tableau de Bord
                </h2>
                <div style="color: #aaa; font-size: 0.95em; margin-top: 8px;" id="dateTimeDisplay">
                    <i class="fas fa-clock"></i> <span id="currentDateTime">--</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="openPDFModal()" class="glass" style="padding: 10px 20px; border: none; border-radius: 12px; color: #fff; cursor: pointer; backdrop-filter: blur(10px); background: rgba(139, 21, 56, 0.2);">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button onclick="refreshData()" class="glass" style="padding: 10px 20px; border: none; border-radius: 12px; color: #fff; cursor: pointer; backdrop-filter: blur(10px); background: rgba(65, 105, 225, 0.2);">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 40px; color: #8B1538;"><i class="fas fa-user-check"></i></div>
                    <div style="flex: 1;">
                        <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Taux Conformit√©</div>
                        <div style="font-size: 2em; font-weight: bold; color: #fff;" id="complianceRate">--</div>
                        <div style="color: #4169E1; font-size: 0.85em; margin-top: 5px;"><i class="fas fa-arrow-up"></i> En temps r√©el</div>
                    </div>
                </div>
            </div>

            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 40px; color: #4169E1;"><i class="fas fa-users"></i></div>
                    <div style="flex: 1;">
                        <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Personnes D√©tect√©es</div>
                        <div style="font-size: 2em; font-weight: bold; color: #fff;" id="totalPersons">--</div>
                        <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">Total du jour</div>
                    </div>
                </div>
            </div>

            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 40px; color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i></div>
                    <div style="flex: 1;">
                        <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Alertes Actives</div>
                        <div style="font-size: 2em; font-weight: bold; color: #fff;" id="activeAlerts">--</div>
                        <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">√Ä traiter</div>
                    </div>
                </div>
            </div>

            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 40px; color: #4db8ff;"><i class="fas fa-shield-alt"></i></div>
                    <div style="flex: 1;">
                        <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">D√©tections Aujourd'hui</div>
                        <div style="font-size: 2em; font-weight: bold; color: #fff;" id="todayDetections">--</div>
                        <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">Total journalier</div>
                    </div>
                </div>
            </div>

            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 40px; color: #4bc0a8;"><i class="fas fa-hard-hat"></i></div>
                    <div style="flex: 1;">
                        <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Casques D√©tect√©s</div>
                        <div style="font-size: 2em; font-weight: bold; color: #fff;" id="withHelmet">--</div>
                        <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">Porteurs de casques</div>
                    </div>
                </div>
            </div>

            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 40px; color: #ffa500;"><i class="fas fa-vest"></i></div>
                    <div style="flex: 1;">
                        <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Gilets D√©tect√©s</div>
                        <div style="font-size: 2em; font-weight: bold; color: #fff;" id="withVest">--</div>
                        <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">Porteurs de gilets</div>
                    </div>
                </div>
            </div>

            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 40px; color: #64c8ff;"><i class="fas fa-glasses"></i></div>
                    <div style="flex: 1;">
                        <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Lunettes D√©tect√©es</div>
                        <div style="font-size: 2em; font-weight: bold; color: #fff;" id="withGlasses">--</div>
                        <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">Porteurs de lunettes</div>
                    </div>
                </div>
            </div>

            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 40px; color: #c864ff;"><i class="fas fa-shoe-prints"></i></div>
                    <div style="flex: 1;">
                        <div style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Bottes D√©tect√©es</div>
                        <div style="font-size: 2em; font-weight: bold; color: #fff;" id="withBoots">--</div>
                        <div style="color: #aaa; font-size: 0.85em; margin-top: 5px;">Porteurs de bottes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRAPHIQUES - Premi√®re Rang√©e -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 40px;">
            <!-- Graphique Courbe - Conformit√© Jour -->
            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); position: relative;">
                <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-line"></i> Conformit√© par Heure</h3>
                <canvas id="complianceChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- Graphique Histogramme - D√©tections par Heure -->
            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); position: relative;">
                <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-bar"></i> D√©tections par Heure</h3>
                <canvas id="hourlyChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- GRAPHIQUES - Deuxi√®me Rang√©e -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 40px;">
            <!-- Graphique Camembert - R√©partition EPI -->
            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-pie"></i> EPI D√©tect√©s</h3>
                <canvas id="epiChart" style="max-height: 280px;"></canvas>
            </div>

            <!-- Graphique Doughnut - Alertes par Niveau -->
            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-exclamation-circle"></i> Alertes par S√©v√©rit√©</h3>
                <canvas id="alertsChart" style="max-height: 280px;"></canvas>
            </div>

            <!-- Graphique Radar - Performance -->
            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-radar"></i> Performance Mod√®le</h3>
                <canvas id="performanceChart" style="max-height: 280px;"></canvas>
            </div>

            <!-- Graphique Surface - Cumul D√©tections -->
            <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="color: #fff; margin-top: 0; margin-bottom: 20px;"><i class="fas fa-chart-area"></i> Cumul D√©tections</h3>
                <canvas id="cumulChart" style="max-height: 280px;"></canvas>
            </div>
        </div>

        <!-- Table des D√©tections R√©centes -->
        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 40px;">
            <h3 style="color: #fff; margin-top: 0;"><i class="fas fa-history"></i> D√©tections R√©centes</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <th style="padding: 12px; text-align: left; color: #8B1538;">Heure</th>
                            <th style="padding: 12px; text-align: left; color: #8B1538;">Personnes</th>
                            <th style="padding: 12px; text-align: left; color: #8B1538;">Casques</th>
                            <th style="padding: 12px; text-align: left; color: #8B1538;">Gilets</th>
                            <th style="padding: 12px; text-align: left; color: #8B1538;">Lunettes</th>
                            <th style="padding: 12px; text-align: left; color: #8B1538;">Conformit√©</th>
                            <th style="padding: 12px; text-align: left; color: #8B1538;">Statut</th>
                        </tr>
                    </thead>
                    <tbody id="detectionsTable" style="color: #ddd;">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alertes R√©centes -->
        <div class="glass-dark" style="padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="color: #fff; margin-top: 0;"><i class="fas fa-bell"></i> Alertes R√©centes</h3>
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 15px;" id="alertsList">
                <!-- Rempli dynamiquement depuis API -->
                <div style="padding: 12px; border-radius: 8px; color: #aaa; text-align: center;">
                    <i class="fas fa-spinner fa-spin"></i> Chargement des alertes...
                </div>
            </div>
        </div>

        <!-- Modal Export PDF -->
        <div id="pdfModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center;">
            <div class="glass-dark" style="padding: 30px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); max-width: 500px; width: 90%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #fff; margin: 0;"><i class="fas fa-file-pdf"></i> Export PDF</h3>
                    <button onclick="closePDFModal()" style="background: none; border: none; color: #aaa; cursor: pointer; font-size: 24px;">‚úï</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="color: #ddd; display: block; margin-bottom: 8px;">Date de d√©but:</label>
                    <input type="date" id="pdfStartDate" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px;" />
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="color: #ddd; display: block; margin-bottom: 8px;">Date de fin:</label>
                    <input type="date" id="pdfEndDate" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px;" />
                </div>

                <div style="color: #aaa; font-size: 13px; margin-bottom: 20px; padding: 10px; border-left: 3px solid #4169E1; background: rgba(65, 105, 225, 0.1);">
                    <i class="fas fa-info-circle"></i> Laissez blanc pour les derniers 7 jours par d√©faut
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closePDFModal()" style="padding: 10px 20px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #ddd; cursor: pointer; font-size: 14px;">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button id="exportPdfBtn" onclick="exportPDF()" style="padding: 10px 20px; border: none; border-radius: 8px; background: rgba(139, 21, 56, 0.8); color: #fff; cursor: pointer; font-size: 14px; font-weight: bold;">
                        <i class="fas fa-download"></i> G√©n√©rer PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script>
let charts = {};

// Fonction utilitaire pour formater les dates avec l'heure du PC
function formatDate(dateString) {
    if (!dateString) {
        return new Date().toLocaleString('fr-FR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    
    try {
        const date = new Date(dateString);
        // V√©rifier si la date est valide
        if (isNaN(date.getTime())) {
            return new Date().toLocaleString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        return date.toLocaleString('fr-FR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    } catch (e) {
        console.warn('‚ö†Ô∏è Date invalide:', dateString);
        return new Date().toLocaleString('fr-FR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
}

// Fonction pour formater l'heure uniquement
function formatTime(dateString) {
    if (!dateString) {
        return new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            return new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    } catch (e) {
        return new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }
}

// Fonction pour afficher la date/heure r√©elle du syst√®me
function updateDateTime() {
    const now = new Date();
    const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    };
    const dateTimeString = now.toLocaleDateString('fr-FR', options);
    document.getElementById('currentDateTime').textContent = dateTimeString;
}

// Mettre √† jour la date/heure toutes les secondes
setInterval(updateDateTime, 1000);
updateDateTime();

// Fonction de rafra√Æchissement des donn√©es
function refreshData() {
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                // Mettre √† jour les KPI avec les vraies valeurs de la base de donn√©es
                document.getElementById('complianceRate').textContent = Math.round(data.compliance_rate) + '%';
                document.getElementById('totalPersons').textContent = data.total_persons || 0;
                document.getElementById('activeAlerts').textContent = data.alerts || 0;
                document.getElementById('todayDetections').textContent = data.detections_today || 0;
                document.getElementById('withHelmet').textContent = data.with_helmet || 0;
                document.getElementById('withVest').textContent = data.with_vest || 0;
                document.getElementById('withGlasses').textContent = data.with_glasses || 0;
                document.getElementById('withBoots').textContent = data.with_boots || 0;
                
                console.log('‚úÖ Donn√©es r√©elles de la base de donn√©es:', {
                    compliance_rate: data.compliance_rate,
                    total_persons: data.total_persons,
                    with_helmet: data.with_helmet,
                    with_vest: data.with_vest,
                    with_glasses: data.with_glasses,
                    with_boots: data.with_boots,
                    alerts: data.alerts,
                    detections_today: data.detections_today
                });
            }
            initCharts(data);
        })
        .catch(err => {
            console.log('‚ö†Ô∏è Erreur API stats:', err);
            console.log('Utilisation des donn√©es de d√©monstration');
            initCharts();
        });
}

function initCharts(data = null) {
    Promise.all([
        fetch('/api/chart/hourly').then(r => r.json()).catch(() => ({})),
        fetch('/api/chart/epi').then(r => r.json()).catch(() => ({})),
        fetch('/api/chart/alerts').then(r => r.json()).catch(() => ({})),
        fetch('/api/chart/cumulative').then(r => r.json()).catch(() => ({}))
    ]).then(([hourlyData, epiData, alertsData, cumulData]) => {
        const demoData = data || {
            compliance_rate: 0,
            total_persons: 0,
            alerts: 0,
            detections_today: 0
        };

        console.log('üìä Donn√©es des graphiques re√ßues:');
        console.log('  ‚Ä¢ Hourly:', hourlyData);
        console.log('  ‚Ä¢ EPI:', epiData);
        console.log('  ‚Ä¢ Alerts:', alertsData);
        console.log('  ‚Ä¢ Cumulative:', cumulData);

        updateCharts(demoData, hourlyData, epiData, alertsData, cumulData);
    });
}

function updateCharts(data, hourlyData, epiData, alertsData, cumulData) {

    const colors = {
        primary: 'rgba(139, 21, 56, 0.8)',   // Garnet
        secondary: 'rgba(65, 105, 225, 0.8)', // Royal Blue
        success: 'rgba(75, 192, 75, 0.8)',    // Green
        warning: 'rgba(255, 165, 0, 0.8)',    // Orange
        danger: 'rgba(255, 107, 107, 0.8)',   // Red
        dark: 'rgba(31, 41, 55, 0.8)'        // Dark
    };

    // 1. Graphique Courbe - Conformit√©
    if (charts.compliance) charts.compliance.destroy();
    const complianceLabels = hourlyData.hours || ['00h', '03h', '06h', '09h', '12h', '15h', '18h', '21h'];
    const complianceValues = hourlyData.compliance || [78, 82, 85, 88, 87, 89, 86, 85];
    
    charts.compliance = new Chart(document.getElementById('complianceChart'), {
        type: 'line',
        data: {
            labels: complianceLabels,
            datasets: [{
                label: 'Taux de Conformit√© (%)',
                data: complianceValues,
                borderColor: colors.primary,
                backgroundColor: 'rgba(139, 21, 56, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointBackgroundColor: colors.primary
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, max: 100, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });

    // 2. Graphique Histogramme - D√©tections par Heure
    if (charts.hourly) charts.hourly.destroy();
    const hourlyLabels = hourlyData.hours || ['00h', '03h', '06h', '09h', '12h', '15h', '18h', '21h'];
    const hourlyDetections = hourlyData.detections || [12, 18, 15, 22, 28, 19, 25, 21];
    
    charts.hourly = new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: {
            labels: hourlyLabels,
            datasets: [{
                label: 'D√©tections',
                data: hourlyDetections,
                backgroundColor: hourlyLabels.map((_, i) => i % 2 === 0 ? colors.primary : colors.secondary),
                borderColor: '#8B1538',
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });

    // 3. Graphique Camembert - EPI
    if (charts.epi) charts.epi.destroy();
    const epiLabels = ['Casques', 'Gilets', 'Lunettes', 'Bottes'];
    const epiValues = [
        epiData.helmets || 0,
        epiData.vests || 0,
        epiData.glasses || 0,
        epiData.boots || 0
    ];
    
    console.log('üéØ Donn√©es EPI D√©tect√©s:', { helmets: epiValues[0], vests: epiValues[1], glasses: epiValues[2], boots: epiValues[3] });
    
    charts.epi = new Chart(document.getElementById('epiChart'), {
        type: 'doughnut',
        data: {
            labels: epiLabels,
            datasets: [{
                data: epiValues,
                backgroundColor: [colors.primary, colors.secondary, 'rgba(75, 192, 75, 0.8)', 'rgba(200, 100, 255, 0.8)'],
                borderColor: '#1F2937',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { labels: { color: '#ddd' } }
            }
        }
    });

    // 4. Graphique Doughnut - Alertes
    if (charts.alerts) charts.alerts.destroy();
    const alertLabels = ['Critique', 'Moyen', 'Bas'];
    const alertValues = [
        alertsData.high || 0,
        alertsData.medium || 0,
        alertsData.low || 0
    ];
    
    console.log('üö® Donn√©es Alertes par S√©v√©rit√©:', { high: alertValues[0], medium: alertValues[1], low: alertValues[2] });
    
    charts.alerts = new Chart(document.getElementById('alertsChart'), {
        type: 'doughnut',
        data: {
            labels: alertLabels,
            datasets: [{
                data: alertValues,
                backgroundColor: ['rgba(255, 107, 107, 0.8)', 'rgba(255, 165, 0, 0.8)', 'rgba(65, 105, 225, 0.8)'],
                borderColor: '#1F2937',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { labels: { color: '#ddd' } }
            }
        }
    });

    // 5. Graphique Radar - Performance
    if (charts.performance) charts.performance.destroy();
    charts.performance = new Chart(document.getElementById('performanceChart'), {
        type: 'radar',
        data: {
            labels: ['Pr√©cision', 'Rappel', 'F1-Score', 'Sp√©cificit√©', 'Sensibilit√©'],
            datasets: [{
                label: 'Performance Mod√®le',
                data: [92, 88, 90, 85, 91],
                borderColor: colors.primary,
                backgroundColor: 'rgba(139, 21, 56, 0.2)',
                pointBackgroundColor: colors.primary,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#aaa' },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                }
            },
            plugins: {
                legend: { labels: { color: '#ddd' } }
            }
        }
    });

    // 6. Graphique Surface - Cumul D√©tections
    if (charts.cumul) charts.cumul.destroy();
    const cumulLabels = cumulData.labels || cumulData.days || ['Jour 1', 'Jour 2', 'Jour 3', 'Jour 4', 'Jour 5', 'Jour 6', 'Jour 7'];
    const cumulValues = cumulData.data || cumulData.cumulative || [50, 120, 180, 260, 350, 420, 485];
    
    console.log('üìà Donn√©es Cumul D√©tections:', { labels: cumulLabels, values: cumulValues });
    
    charts.cumul = new Chart(document.getElementById('cumulChart'), {
        type: 'line',
        data: {
            labels: cumulLabels,
            datasets: [{
                label: 'Cumul D√©tections',
                data: cumulValues,
                borderColor: colors.secondary,
                backgroundColor: 'rgba(65, 105, 225, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: colors.secondary
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });
}

// Fonction pour ouvrir la modal PDF
function openPDFModal() {
    const today = new Date().toISOString().split('T')[0];
    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    // Pr√©remplir avec les valeurs par d√©faut (7 derniers jours)
    document.getElementById('pdfStartDate').value = sevenDaysAgo;
    document.getElementById('pdfEndDate').value = today;
    
    document.getElementById('pdfModal').style.display = 'flex';
}

// Fonction pour fermer la modal PDF
function closePDFModal() {
    document.getElementById('pdfModal').style.display = 'none';
}

// Fermer la modal au clic en dehors du contenu
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('pdfModal');
    modal?.addEventListener('click', (e) => {
        if (e.target === modal) {
            closePDFModal();
        }
    });
});

function exportPDF() {
    const startDate = document.getElementById('pdfStartDate')?.value;
    const endDate = document.getElementById('pdfEndDate')?.value;
    
    // Cr√©er l'URL avec les param√®tres de date
    // NOTE: route d√©finie dans app/routes_stats.py est '/api/export/detection-pdf'
    let url = '/api/export/detection-pdf';
    const params = [];
    
    if (startDate) params.push(`start_date=${startDate}`);
    if (endDate) params.push(`end_date=${endDate}`);
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    // Montrer un message de chargement
    const exportBtn = document.getElementById('exportPdfBtn');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration en cours...';
    exportBtn.disabled = true;
    
    console.log('üì• Requesting PDF from:', url);
    
    // T√©l√©charger le PDF (avec fallback)
    fetch(url)
        .then(response => {
            console.log('üìä Response status:', response.status);
            const contentType = response.headers.get('content-type');

            if (!response.ok) {
                if (contentType && contentType.includes('application/json')) {
                    return response.json().then(data => { throw new Error(data.error || `Erreur HTTP ${response.status}`); });
                }
                return response.text().then(text => { throw new Error(`Erreur serveur (${response.status}): ${text.substring(0,200)}`); });
            }

            if (!contentType || !contentType.includes('application/pdf')) {
                return response.text().then(text => { throw new Error(`Format invalide. Attendu PDF, re√ßu: ${contentType}`); });
            }

            return response.blob();
        })
        .then(blob => {
            console.log('‚úÖ PDF received, size:', blob.size, 'bytes');
            if (blob.size < 1000) throw new Error('PDF seems too small');
            const downloadUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `rapport_epi_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(downloadUrl);
            exportBtn.innerHTML = '<i class="fas fa-check"></i> T√©l√©chargement r√©ussi!';
            setTimeout(() => { closePDFModal(); }, 1200);
        })
        .catch(err => {
            console.error('‚ùå Erreur export PDF (fetch):', err);
            // Fallback: ouvrir l'URL dans un nouvel onglet pour laisser le navigateur g√©rer le t√©l√©chargement
            try {
                console.warn('Tentative de fallback: ouverture directe de l\'URL dans un nouvel onglet');
                window.open(url, '_blank');
            } catch (e) {
                console.error('Fallback failed:', e);
                alert(`‚ùå Erreur lors de l'export: ${err.message}`);
            }
        })
        .finally(() => {
            setTimeout(() => {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
                exportBtn.style.background = '';
            }, 2000);
        });
}

function loadDetections() {
    fetch('/api/realtime?limit=10')
        .then(r => r.json())
        .then(data => {
            const table = document.getElementById('detectionsTable');
            table.innerHTML = '';
            
            console.log('üìã Donn√©es d√©tections re√ßues:', data);
            
            if (data.full_data && data.full_data.length > 0) {
                for (let i = 0; i < data.full_data.length && i < 10; i++) {
                    const det = data.full_data[i];
                    
                    // Utiliser la fonction formatTime avec validation
                    const time = formatTime(det.timestamp);
                    
                    // Calculer le taux de conformit√© pour cette d√©tection
                    const total = det.total_persons || 0;
                    const compliant = total > 0 ? Math.min(det.with_helmet || 0, det.with_vest || 0, det.with_glasses || 0) : 0;
                    const conformityRate = total > 0 ? Math.round((compliant / total) * 100) : 0;
                    
                    // D√©terminer le statut (couleur)
                    const statusColor = conformityRate >= 80 ? '#4bc0a8' : conformityRate >= 50 ? '#ffa500' : '#ff6b6b';
                    const statusText = conformityRate >= 80 ? '‚úì Conforme' : conformityRate >= 50 ? '‚ö† Partiel' : '‚úó Non-conforme';
                    
                    const row = `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 12px; color: #4169E1;">${time}</td>
                            <td style="padding: 12px; color: #fff;">${det.total_persons || 0}</td>
                            <td style="padding: 12px; color: #4bc0a8;">${det.with_helmet || 0}</td>
                            <td style="padding: 12px; color: #ffa500;">${det.with_vest || 0}</td>
                            <td style="padding: 12px; color: #64c8ff;">${det.with_glasses || 0}</td>
                            <td style="padding: 12px; color: #fff;">${conformityRate}%</td>
                            <td style="padding: 12px; color: ${statusColor};">${statusText}</td>
                        </tr>
                    `;
                    table.innerHTML += row;
                }
            } else {
                table.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #aaa;">Aucune d√©tection enregistr√©e</td></tr>';
            }
        })
        .catch(err => {
            console.error('‚ùå Erreur loadDetections:', err);
            const table = document.getElementById('detectionsTable');
            table.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #aaa;">Impossible de charger les donn√©es</td></tr>';
        });
}

function loadAlerts() {
    fetch('/api/alerts')
        .then(r => r.json())
        .then(data => {
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = '';
            
            if (data.alerts && data.alerts.length > 0) {
                for (let i = 0; i < data.alerts.length && i < 5; i++) {
                    const alert = data.alerts[i];
                    const severity = alert.severity || 'medium';
                    
                    const severityColors = {
                        'high': '#ff6b6b',
                        'medium': '#ffa500',
                        'low': '#4169E1'
                    };
                    
                    const color = severityColors[severity] || '#aaa';
                    
                    // Utiliser directement le timestamp format√© par l'API
                    const dateStr = alert.timestamp || new Date().toLocaleString('fr-FR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const alertEl = `
                        <div style="padding: 12px; border-radius: 8px; background: rgba(${severity === 'high' ? '255,107,107' : severity === 'medium' ? '255,165,0' : '65,105,225'},0.1); border-left: 4px solid ${color}; color: ${color};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">${alert.message || 'Alerte'}</div>
                                    <div style="font-size: 0.9em; color: #aaa;"><i class="fas fa-clock"></i> ${dateStr}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    alertsList.innerHTML += alertEl;
                }
            } else {
                alertsList.innerHTML = '<div style="padding: 12px; border-radius: 8px; color: #4bc0a8; text-align: center;">‚úì Aucune alerte active</div>';
            }
        })
        .catch(err => {
            console.error('‚ùå Erreur loadAlerts:', err);
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = '<div style="padding: 12px; border-radius: 8px; color: #aaa; text-align: center;">Impossible de charger les alertes</div>';
        });
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
    refreshData();
    loadDetections();
    loadAlerts();
    setInterval(refreshData, 5000); // Rafra√Æchir tous les 5s pour donn√©es plus en direct
    setInterval(loadDetections, 3000); // Charger les d√©tections tous les 3s pour temps quasi-r√©el
    setInterval(loadAlerts, 3000); // Charger les alertes tous les 3s pour temps quasi-r√©el
});
</script>
{% endblock %}