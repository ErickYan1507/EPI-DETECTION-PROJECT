{% extends "base.html" %}

{% block title %}üìß Configuration Email - EPI Detection{% endblock %}

{% block extra_css %}
<style>
    .email-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .card-section { background: white; border-radius: 10px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .section-title { font-size: 1.3em; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: #333; }
    .form-group { margin-bottom: 15px; }
    .form-group label { font-weight: 600; margin-bottom: 5px; display: block; color: #555; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.95em; box-sizing: border-box; }
    .form-group input:focus, .form-group select:focus { border-color: #8B1538; outline: none; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
    .btn-primary { background: #8B1538; color: white; }
    .btn-primary:hover { background: #6d0e2a; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-info:hover { background: #138496; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
    .status-ok { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .alert { padding: 15px; border-radius: 5px; margin-bottom: 15px; }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
    .divider { border-top: 2px solid #eee; margin: 20px 0; }
    .recipient-list { list-style: none; padding: 0; margin: 10px 0; }
    .recipient-item { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .recipient-item button { padding: 5px 10px; font-size: 0.85em; }
    .schedule-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    .schedule-table th, .schedule-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    .schedule-table th { background: #f8f9fa; font-weight: 600; }
    .test-result { margin-top: 15px; padding: 15px; border-radius: 5px; }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #8B1538; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .action-buttons button { flex: 1; min-width: 150px; }
    small { display: block; margin-top: 3px; }
</style>
{% endblock %}

{% block content %}
<div class="email-container">
    <!-- En-t√™te -->
    <div class="card-section" style="background: linear-gradient(135deg, #8B1538 0%, #6d0e2a 100%); color: white;">
        <h1><i class="fas fa-envelope"></i> Configuration Email - Rapports Automatiques</h1>
        <p style="margin-top: 10px; opacity: 0.9;">G√©rez vos notifications par email et vos rapports programm√©s</p>
    </div>

    <!-- Alerte de statut -->
    <div id="statusAlert"></div>

    <!-- ========== SECTION 1: Configuration SMTP ========== -->
    <div class="card-section">
        <div class="section-title">
            <i class="fas fa-cog"></i> Configuration SMTP Gmail
        </div>
        
        <div class="grid-2">
            <div>
                <div class="form-group">
                    <label>üìß Email d'exp√©dition (Gmail)</label>
                    <input type="email" id="senderEmail" placeholder="votre.email@gmail.com">
                    <small style="color: #999;">Compte Gmail avec 2FA activ√©e</small>
                </div>
                <div class="form-group">
                    <label>üîë Mot de passe d'application</label>
                    <input type="password" id="senderPassword" placeholder="Mot de passe app (16 caract√®res)">
                    <small style="color: #999;">Pas votre mot de passe Gmail normal!</small>
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label>üåê Serveur SMTP</label>
                    <input type="text" id="smtpServer" placeholder="smtp.gmail.com" value="smtp.gmail.com">
                </div>
                <div class="form-group">
                    <label>‚öôÔ∏è Port SMTP</label>
                    <input type="number" id="smtpPort" placeholder="587" value="587">
                </div>
            </div>
        </div>

        <div class="divider"></div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveEmailConfig()">
                <i class="fas fa-save"></i> Sauvegarder Configuration
            </button>
            <button class="btn btn-info" onclick="testSmtpConnection()">
                <i class="fas fa-wifi"></i> Tester Connexion SMTP
            </button>
            <button class="btn btn-secondary" onclick="sendTestEmail()">
                <i class="fas fa-paper-plane"></i> Envoyer Email Test
            </button>
        </div>
        
        <div id="testResult" style="display: none;"></div>
    </div>

    <!-- ========== SECTION 2: Destinataires ========== -->
    <div class="card-section">
        <div class="section-title">
            <i class="fas fa-users"></i> Destinataires des Rapports
        </div>
        
        <div class="form-group">
            <label>‚ûï Ajouter Email Destinataire</label>
            <div style="display: flex; gap: 10px;">
                <input type="email" id="newRecipient" placeholder="admin@company.com" style="flex: 1;">
                <button class="btn btn-primary" onclick="addRecipient()" style="flex: 0;">Ajouter</button>
            </div>
        </div>

        <div>
            <label style="font-weight: 600; margin-top: 15px; display: block;">üì¨ Emails Configur√©s:</label>
            <ul class="recipient-list" id="recipientList">
                <li class="recipient-item">
                    <span><div class="spinner"></div> Chargement...</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- ========== SECTION 3: Horaires des Rapports ========== -->
    <div class="card-section">
        <div class="section-title">
            <i class="fas fa-calendar"></i> Horaires des Rapports Programm√©s
        </div>
        
        <div class="grid-2">
            <div>
                <h5 style="color: #8B1538; margin-bottom: 15px;">üìä Rapport Quotidien</h5>
                <div class="form-group">
                    <label>‚è∞ Heure d'envoi (0-23)</label>
                    <input type="number" id="dailyHour" min="0" max="23" value="8">
                    <small style="color: #999;">Tous les jours √† cette heure</small>
                </div>
            </div>

            <div>
                <h5 style="color: #8B1538; margin-bottom: 15px;">üìÖ Rapport Hebdomadaire</h5>
                <div class="form-group">
                    <label>üìÜ Jour de la semaine</label>
                    <select id="weeklyDay">
                        <option value="0">Lundi</option>
                        <option value="1">Mardi</option>
                        <option value="2">Mercredi</option>
                        <option value="3">Jeudi</option>
                        <option value="4">Vendredi</option>
                        <option value="5">Samedi</option>
                        <option value="6">Dimanche</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‚è∞ Heure d'envoi (0-23)</label>
                    <input type="number" id="weeklyHour" min="0" max="23" value="9">
                </div>
            </div>

            <div>
                <h5 style="color: #8B1538; margin-bottom: 15px;">üìÜ Rapport Mensuel</h5>
                <div class="form-group">
                    <label>üìå Jour du mois (1-31)</label>
                    <input type="number" id="monthlyDay" min="1" max="31" value="1">
                </div>
                <div class="form-group">
                    <label>‚è∞ Heure d'envoi (0-23)</label>
                    <input type="number" id="monthlyHour" min="0" max="23" value="9">
                </div>
            </div>

            <div>
                <h5 style="color: #8B1538; margin-bottom: 15px;">üö® Alertes de Conformit√©</h5>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="alertsEnabled" checked>
                        Alertes activ√©es
                    </label>
                </div>
                <div class="form-group">
                    <label>‚ö†Ô∏è Seuil d'alerte (en %)</label>
                    <input type="number" id="alertThreshold" min="0" max="100" value="80">
                    <small style="color: #999;">Alerte si conformit√© < seuil</small>
                </div>
            </div>
        </div>

        <div class="divider"></div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveSchedules()">
                <i class="fas fa-save"></i> Sauvegarder Horaires
            </button>
            <button class="btn btn-info" onclick="showSchedulerStatus()">
                <i class="fas fa-info-circle"></i> Voir √âtat Scheduler
            </button>
        </div>
    </div>

    <!-- ========== SECTION 4: Actions Rapides ========== -->
    <div class="card-section">
        <div class="section-title">
            <i class="fas fa-bolt"></i> Actions Rapides
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-success" onclick="sendDailyReport()">
                <i class="fas fa-chart-bar"></i> Rapport Quotidien Maintenant
            </button>
            <button class="btn btn-success" onclick="sendWeeklyReport()">
                <i class="fas fa-chart-line"></i> Rapport Hebdo Maintenant
            </button>
            <button class="btn btn-success" onclick="sendMonthlyReport()">
                <i class="fas fa-chart-pie"></i> Rapport Mensuel Maintenant
            </button>
            <button class="btn btn-secondary" onclick="exportPresencePDF()">
                <i class="fas fa-file-pdf"></i> Exporter PDF Pr√©sence
            </button>
        </div>
    </div>

    <!-- ========== SECTION 5: √âtat du Syst√®me ========== -->
    <div class="card-section">
        <div class="section-title">
            <i class="fas fa-heartbeat"></i> √âtat du Syst√®me Email
        </div>
        
        <table class="schedule-table">
            <thead>
                <tr>
                    <th>Composant</th>
                    <th>√âtat</th>
                    <th>D√©tails</th>
                </tr>
            </thead>
            <tbody id="statusTable">
                <tr>
                    <td colspan="3" style="text-align: center;">
                        <div class="spinner"></div> Chargement...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
let currentConfig = {};

document.addEventListener('DOMContentLoaded', function() {
    loadConfiguration();
    loadRecipients();
    loadSystemStatus();
    setInterval(loadSystemStatus, 30000);
});

function apiCall(endpoint, method = 'GET', data = null) {
    const options = {
        method: method,
        headers: { 'Content-Type': 'application/json' }
    };
    if (data) options.body = JSON.stringify(data);
    return fetch(endpoint, options).then(r => r.json());
}

function showStatus(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = message;
    const container = document.getElementById('statusAlert');
    container.innerHTML = '';
    container.appendChild(alert);
    setTimeout(() => alert.style.display = 'none', 5000);
}

function loadConfiguration() {
    apiCall('/api/email/config').then(data => {
        if (data.success) {
            currentConfig = data.config;
            document.getElementById('senderEmail').value = data.config.SENDER_EMAIL || '';
            document.getElementById('senderPassword').value = data.config.SENDER_PASSWORD || '';
            document.getElementById('smtpServer').value = data.config.SMTP_SERVER || 'smtp.gmail.com';
            document.getElementById('smtpPort').value = data.config.SMTP_PORT || '587';
            document.getElementById('dailyHour').value = data.config.DAILY_REPORT_HOUR || '8';
            document.getElementById('weeklyDay').value = data.config.WEEKLY_REPORT_DAY || '1';
            document.getElementById('weeklyHour').value = data.config.WEEKLY_REPORT_HOUR || '9';
            document.getElementById('monthlyDay').value = data.config.MONTHLY_REPORT_DAY || '1';
            document.getElementById('monthlyHour').value = data.config.MONTHLY_REPORT_HOUR || '9';
            document.getElementById('alertsEnabled').checked = data.config.SEND_ALERTS_ENABLED !== 'false';
            document.getElementById('alertThreshold').value = data.config.ALERT_THRESHOLD || '80';
        }
    });
}

function saveEmailConfig() {
    const config = {
        SENDER_EMAIL: document.getElementById('senderEmail').value,
        SENDER_PASSWORD: document.getElementById('senderPassword').value,
        SMTP_SERVER: document.getElementById('smtpServer').value,
        SMTP_PORT: document.getElementById('smtpPort').value,
    };
    
    if (!config.SENDER_EMAIL) {
        showStatus('‚ö†Ô∏è Email exp√©diteur requis!', 'error');
        return;
    }
    
    apiCall('/api/email/config', 'POST', config).then(data => {
        if (data.success) {
            showStatus('‚úÖ Configuration SMTP sauvegard√©e!', 'success');
        } else {
            showStatus('‚ùå Erreur: ' + data.error, 'error');
        }
    });
}

function testSmtpConnection() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Test...';
    
    apiCall('/api/email/test-connection').then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-wifi"></i> Tester Connexion SMTP';
        
        const tester = document.getElementById('testResult');
        tester.style.display = 'block';
        
        if (data.success) {
            tester.innerHTML = `<div class="test-result alert-success">
                <strong>‚úÖ Connexion R√©ussie!</strong><br>
                Serveur: ${data.server}:${data.port}
            </div>`;
            showStatus('‚úÖ Connexion SMTP r√©ussie!', 'success');
        } else {
            tester.innerHTML = `<div class="test-result alert-error">
                <strong>‚ùå Erreur: ${data.error}</strong>
            </div>`;
        }
    });
}

function sendTestEmail() {
    const email = document.getElementById('senderEmail').value;
    if (!email) {
        showStatus('‚ùå Veuillez configurer un email d\'exp√©dition!', 'error');
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Envoi...';
    
    apiCall('/api/email/send-test', 'POST', {recipient: email}).then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Envoyer Email Test';
        
        if (data.success) {
            showStatus('‚úÖ Email test envoy√©!', 'success');
        } else {
            showStatus('‚ùå Erreur: ' + data.error, 'error');
        }
    });
}

function loadRecipients() {
    apiCall('/api/email/recipients').then(data => {
        const list = document.getElementById('recipientList');
        list.innerHTML = '';
        if (data.recipients && data.recipients.length > 0) {
            data.recipients.forEach(email => {
                list.innerHTML += `<li class="recipient-item"><span>üìß ${email}</span><button class="btn btn-danger" onclick="removeRecipient('${email}')"><i class="fas fa-trash"></i></button></li>`;
            });
        } else {
            list.innerHTML = '<li class="recipient-item"><em>Aucun destinataire</em></li>';
        }
    });
}

function addRecipient() {
    const email = document.getElementById('newRecipient').value.trim();
    if (!email) {
        showStatus('‚ùå Veuillez entrer un email!', 'error');
        return;
    }
    
    apiCall('/api/email/recipients', 'POST', {email: email}).then(data => {
        if (data.success) {
            document.getElementById('newRecipient').value = '';
            loadRecipients();
            showStatus('‚úÖ Email ajout√©!', 'success');
        } else {
            showStatus('‚ùå ' + data.error, 'error');
        }
    });
}

function removeRecipient(email) {
    if (confirm(`Retirer ${email}?`)) {
        apiCall('/api/email/recipients', 'DELETE', {email: email}).then(data => {
            if (data.success) {
                loadRecipients();
                showStatus('‚úÖ Email supprim√©!', 'success');
            }
        });
    }
}

function saveSchedules() {
    apiCall('/api/email/schedules', 'POST', {
        DAILY_REPORT_HOUR: document.getElementById('dailyHour').value,
        WEEKLY_REPORT_DAY: document.getElementById('weeklyDay').value,
        WEEKLY_REPORT_HOUR: document.getElementById('weeklyHour').value,
        MONTHLY_REPORT_DAY: document.getElementById('monthlyDay').value,
        MONTHLY_REPORT_HOUR: document.getElementById('monthlyHour').value,
        SEND_ALERTS_ENABLED: document.getElementById('alertsEnabled').checked,
        ALERT_THRESHOLD: document.getElementById('alertThreshold').value,
    }).then(data => {
        if (data.success) {
            showStatus('‚úÖ Horaires sauvegard√©s! Red√©marrez l\'app pour activer.', 'success');
        } else {
            showStatus('‚ùå Erreur: ' + data.error, 'error');
        }
    });
}

function sendDailyReport() {
    sendReportNow('daily', event.target);
}

function sendWeeklyReport() {
    sendReportNow('weekly', event.target);
}

function sendMonthlyReport() {
    sendReportNow('monthly', event.target);
}

function sendReportNow(type, btn) {
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Envoi...';
    
    apiCall('/api/email/send-report', 'POST', {type: type}).then(data => {
        btn.disabled = false;
        btn.innerHTML = btn.innerHTML.replace('<div class="spinner"></div> Envoi...', '<i class="fas fa-chart-bar"></i>');
        if (data.success) {
            showStatus(`‚úÖ Rapport ${type} envoy√©!`, 'success');
        } else {
            showStatus('‚ùå ' + data.error, 'error');
        }
    });
}

function loadSystemStatus() {
    apiCall('/api/email/status').then(data => {
        const table = document.getElementById('statusTable');
        table.innerHTML = '';
        const items = [
            {name: 'Configuration SMTP', status: data.smtp_configured ? 'OK' : '√Ä configurer', icon: '‚öôÔ∏è'},
            {name: 'Connexion SMTP', status: data.smtp_connected ? 'Connect√©' : 'Erreur', icon: 'üåê'},
            {name: 'Destinataires', status: (data.recipients_count || 0) > 0 ? `${data.recipients_count} email(s)` : 'Aucun', icon: 'üìß'},
            {name: 'Scheduler', status: data.scheduler_running ? 'Actif' : 'Arr√™t√©', icon: '‚è∞'},
        ];
        
        items.forEach(item => {
            const isOk = item.status !== 'Erreur' && item.status !== '√Ä configurer' && item.status !== 'Arr√™t√©' && item.status !== 'Aucun';
            table.innerHTML += `<tr><td>${item.icon} ${item.name}</td><td><span class="status-badge ${isOk ? 'status-ok' : 'status-error'}">${item.status}</span></td><td>-</td></tr>`;
        });
    });
}

function showSchedulerStatus() {
    showStatus('üìä Scheduler programm√© selon vos horaires configur√©s. Red√©marrez l\'app pour l\'activer.', 'info');
}

function exportPresencePDF() {
    window.location.href = '/api/export/presence-pdf?start_date=2026-02-01&end_date=2026-02-13';
}
</script>
{% endblock %}</content>
<parameter name="filePath">D:\projet\EPI-DETECTION-PROJECT\templates\notifications.html