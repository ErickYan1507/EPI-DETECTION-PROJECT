{% extends "base.html" %}

{% block title %}Dashboard Unifi√© - EPI Detection v2.0{% endblock %}

{% block extra_css %}
    <style>
        /* Variables CSS personnalis√©es */
        .header {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background: #4ade80;
        }

        .status-indicator.offline {
            background: #ef4444;
            animation: none;
        }

        .status-indicator.warning {
            background: #fbbf24;
            animation: pulse-warning 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--glass-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .card:hover {
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: var(--color-secondary);
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 10px;
        }

        .camera-feed {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            position: relative;
            overflow: hidden;
        }

        .camera-feed video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-feed.offline {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        }

        .detection-box {
            position: absolute;
            border: 2px solid #00ff00;
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            padding: 5px;
            font-size: 0.9em;
            border-radius: 4px;
        }

        .alert-container {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .alert {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid;
            background: #f0f9ff;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert.danger {
            border-color: #ef4444;
            background: #fee2e2;
            color: #7f1d1d;
        }

        .alert.warning {
            border-color: #f59e0b;
            background: #fef3c7;
            color: #78350f;
        }

        .alert.success {
            border-color: #10b981;
            background: #d1fae5;
            color: #065f46;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .metric {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--color-secondary);
        }

        .metric-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border: 1px solid var(--color-secondary);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .detection-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .detection-item {
            background: var(--bg-tertiary);
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 4px solid var(--color-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
        }

        .detection-item.helmet {
            border-left-color: #fbbf24;
        }

        .detection-item.vest {
            border-left-color: #f97316;
        }

        .detection-item.glasses {
            border-left-color: #06b6d4;
        }

        .detection-item.person {
            border-left-color: #6366f1;
        }

        .detection-item.boots {
            border-left-color: #8b5cf6;
        }

        .confidence {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .live-chart {
            width: 100%;
            height: 300px;
            margin-top: 15px;
            background: #f9fafb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .footer {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 30px;
            padding: 20px;
            background: var(--glass-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        .device-data {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .unified-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Layout Responsive Unifi√© */
        @media (max-width: 1600px) {
            .unified-layout {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 1200px) {
            .unified-layout {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }

        .notification-sound {
            display: none;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
{% endblock %}

{% block content %}
        <!-- Header -->
        <div class="header">
            <h1>üé• Syst√®me de D√©tection EPI - Dashboard Temps R√©el v2.0</h1>
            <p class="subtitle">Monitoring Unifi√© - Cam√©ra + D√©tection IA + Arduino en Temps R√©el</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator online" id="camera-status"></div>
                    <span>Cam√©ra: <strong id="camera-status-text">En attente...</strong></span>
                </div>
                <div class="status-item">
                    <div class="status-indicator online" id="detection-status"></div>
                    <span>D√©tection: <strong id="detection-status-text">En attente...</strong></span>
                </div>
                <div class="status-item">
                    <span>ü§ñ Mode: 
                        <select id="detection-mode-select" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; cursor: pointer;">
                            <option value="ensemble" style="background: #1A1F2E; color: white;">Ensemble (Multi-Mod√®les)</option>
                            <option value="single" style="background: #1A1F2E; color: white;">Single (best.pt)</option>
                        </select>
                    </span>
                </div>
            </div>
        </div>

        <!-- SECTION 0: Configuration P√©riph√©riques Physiques (Optionnel) -->
        <div class="card" style="margin-bottom: 30px; background: rgba(139, 92, 246, 0.05); border: 2px solid rgba(139, 92, 246, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 class="card-title" style="margin: 0;">‚öôÔ∏è Configuration P√©riph√©riques Physiques (Optionnel)</h2>
                <button id="toggle-device-config" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9em;">‚ñº Afficher</button>
            </div>

            <div id="device-config-section" style="display: none;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #8b5cf6; margin-top: 0; margin-bottom: 15px;">üìç Activation des P√©riph√©riques</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <!-- Arduino / TinkerCAD -->
                        <div style="border: 1px solid rgba(139, 92, 246, 0.3); padding: 15px; border-radius: 8px; background: rgba(139, 92, 246, 0.08);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                <input type="checkbox" id="device-arduino" checked style="margin-right: 10px; cursor: pointer; width: 18px; height: 18px;">
                                <span style="font-weight: bold; color: #8b5cf6; font-size: 1.05em;">üîå Arduino TinkerCAD</span>
                            </label>
                            <div style="font-size: 0.9em; color: #999; margin-left: 28px; line-height: 1.5;">
                                ‚Ä¢ D√©tection de mouvement (PIR)<br>
                                ‚Ä¢ Capteurs temp√©rature/humidit√©<br>
                                ‚Ä¢ LEDs d'√©tat (vert/rouge)<br>
                                ‚Ä¢ Buzzer d'alerte
                            </div>
                            <input type="text" id="arduino-port" placeholder="COM3 ou /dev/ttyUSB0" style="width: 100%; margin-top: 10px; padding: 6px; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 4px; background: rgba(0,0,0,0.2); color: #e2e8f0; font-size: 0.9em;" value="COM3">
                        </div>

                        <!-- Capteurs MQTT -->
                        <div style="border: 1px solid rgba(59, 130, 246, 0.3); padding: 15px; border-radius: 8px; background: rgba(59, 130, 246, 0.08);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                <input type="checkbox" id="device-mqtt" style="margin-right: 10px; cursor: pointer; width: 18px; height: 18px;">
                                <span style="font-weight: bold; color: #3b82f6; font-size: 1.05em;">üåê Capteurs MQTT</span>
                            </label>
                            <div style="font-size: 0.9em; color: #999; margin-left: 28px; line-height: 1.5;">
                                ‚Ä¢ Temp√©rature ambiante<br>
                                ‚Ä¢ Humidit√© relative<br>
                                ‚Ä¢ Pression atmosph√©rique<br>
                                ‚Ä¢ Qualit√© de l'air
                            </div>
                            <input type="text" id="mqtt-broker" placeholder="mqtt.example.com:1883" style="width: 100%; margin-top: 10px; padding: 6px; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; background: rgba(0,0,0,0.2); color: #e2e8f0; font-size: 0.9em;" value="localhost:1883">
                        </div>

                        <!-- Capteurs R√©seau (Network IoT) -->
                        <div style="border: 1px solid rgba(249, 115, 22, 0.3); padding: 15px; border-radius: 8px; background: rgba(249, 115, 22, 0.08);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                <input type="checkbox" id="device-network" style="margin-right: 10px; cursor: pointer; width: 18px; height: 18px;">
                                <span style="font-weight: bold; color: #f97316; font-size: 1.05em;">üì° Capteurs R√©seau (HTTP)</span>
                            </label>
                            <div style="font-size: 0.9em; color: #999; margin-left: 28px; line-height: 1.5;">
                                ‚Ä¢ Requ√™tes HTTP p√©riodiques<br>
                                ‚Ä¢ APIs REST personnalis√©es<br>
                                ‚Ä¢ Webhooks IoT<br>
                                ‚Ä¢ Int√©gration cloud
                            </div>
                            <input type="text" id="network-endpoint" placeholder="http://sensor-api.local/data" style="width: 100%; margin-top: 10px; padding: 6px; border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 4px; background: rgba(0,0,0,0.2); color: #e2e8f0; font-size: 0.9em;" value="http://localhost:8000/api/sensors">
                        </div>

                        <!-- Capteurs Bluetooth -->
                        <div style="border: 1px solid rgba(139, 92, 246, 0.3); padding: 15px; border-radius: 8px; background: rgba(139, 92, 246, 0.08);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                <input type="checkbox" id="device-bluetooth" style="margin-right: 10px; cursor: pointer; width: 18px; height: 18px;">
                                <span style="font-weight: bold; color: #8b5cf6; font-size: 1.05em;">üîµ Appareils Bluetooth</span>
                            </label>
                            <div style="font-size: 0.9em; color: #999; margin-left: 28px; line-height: 1.5;">
                                ‚Ä¢ Capteurs BLE wearables<br>
                                ‚Ä¢ Traceurs de position<br>
                                ‚Ä¢ Montres connect√©es<br>
                                ‚Ä¢ Appareils m√©dicaux
                            </div>
                            <input type="text" id="bluetooth-device" placeholder="Device UUID ou adresse MAC" style="width: 100%; margin-top: 10px; padding: 6px; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 4px; background: rgba(0,0,0,0.2); color: #e2e8f0; font-size: 0.9em;" value="">
                        </div>

                        <!-- Capteurs USB -->
                        <div style="border: 1px solid rgba(6, 182, 212, 0.3); padding: 15px; border-radius: 8px; background: rgba(6, 182, 212, 0.08);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                <input type="checkbox" id="device-usb" style="margin-right: 10px; cursor: pointer; width: 18px; height: 18px;">
                                <span style="font-weight: bold; color: #06b6d4; font-size: 1.05em;">üîå Appareils USB</span>
                            </label>
                            <div style="font-size: 0.9em; color: #999; margin-left: 28px; line-height: 1.5;">
                                ‚Ä¢ Capteurs USB directs<br>
                                ‚Ä¢ Cam√©ras thermiques<br>
                                ‚Ä¢ Analyseurs de qualit√©<br>
                                ‚Ä¢ Lecteurs de badge
                            </div>
                            <input type="text" id="usb-device-id" placeholder="Vendor ID:Product ID" style="width: 100%; margin-top: 10px; padding: 6px; border: 1px solid rgba(6, 182, 212, 0.3); border-radius: 4px; background: rgba(0,0,0,0.2); color: #e2e8f0; font-size: 0.9em;" value="">
                        </div>

                        <!-- Int√©gration Cloud / Edge -->
                        <div style="border: 1px solid rgba(16, 185, 129, 0.3); padding: 15px; border-radius: 8px; background: rgba(16, 185, 129, 0.08);">
                            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                <input type="checkbox" id="device-cloud" style="margin-right: 10px; cursor: pointer; width: 18px; height: 18px;">
                                <span style="font-weight: bold; color: #10b981; font-size: 1.05em;">‚òÅÔ∏è Cloud / Edge Computing</span>
                            </label>
                            <div style="font-size: 0.9em; color: #999; margin-left: 28px; line-height: 1.5;">
                                ‚Ä¢ Azure IoT Hub<br>
                                ‚Ä¢ AWS IoT Core<br>
                                ‚Ä¢ Google Cloud IoT<br>
                                ‚Ä¢ Edge Devices (Nvidia Jetson)
                            </div>
                            <input type="text" id="cloud-config" placeholder="API Key ou Connection String" style="width: 100%; margin-top: 10px; padding: 6px; border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 4px; background: rgba(0,0,0,0.2); color: #e2e8f0; font-size: 0.9em;" value="">
                        </div>
                    </div>

                    <!-- Param√®tres G√©n√©raux -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(139, 92, 246, 0.2);">
                        <h4 style="color: #8b5cf6; margin-top: 0; margin-bottom: 15px;">‚öôÔ∏è Param√®tres G√©n√©raux</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="color: #e2e8f0; font-size: 0.9em; display: block; margin-bottom: 5px;">Intervalle de scan (ms)</label>
                                <input type="number" id="scan-interval" value="5000" min="1000" max="60000" style="width: 100%; padding: 6px; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 4px; background: rgba(0,0,0,0.2); color: #e2e8f0;">
                            </div>
                            <div>
                                <label style="color: #e2e8f0; font-size: 0.9em; display: block; margin-bottom: 5px;">Timeout de connexion (s)</label>
                                <input type="number" id="connection-timeout" value="10" min="1" max="120" style="width: 100%; padding: 6px; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 4px; background: rgba(0,0,0,0.2); color: #e2e8f0;">
                            </div>
                            <div>
                                <label style="color: #e2e8f0; font-size: 0.9em; display: block; margin-bottom: 5px;">Tentatives de reconnexion</label>
                                <input type="number" id="reconnect-attempts" value="5" min="1" max="20" style="width: 100%; padding: 6px; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 4px; background: rgba(0,0,0,0.2); color: #e2e8f0;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons d'Action -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="apply-device-config" style="padding: 10px 20px; font-size: 1em; flex: 1; min-width: 150px;">‚úÖ Appliquer Configuration</button>
                    <button class="btn btn-secondary" id="test-devices" style="padding: 10px 20px; font-size: 1em; flex: 1; min-width: 150px;">üß™ Tester P√©riph√©riques</button>
                    <button class="btn btn-secondary" id="reset-device-config" style="padding: 10px 20px; font-size: 1em; flex: 1; min-width: 150px;">üîÑ R√©initialiser</button>
                </div>

                <!-- √âtat de Connexion -->
                <div id="device-status-log" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; font-family: monospace; font-size: 0.9em; color: #10b981; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; border: 1px solid rgba(16, 185, 129, 0.3);">
                    üìç √âtat de connexion des p√©riph√©riques...
                </div>
            </div>
        </div>

        <!-- SECTION 1: Arduino / IoT Dashboard -->
        <div class="card" style="margin-bottom: 30px;">
            <h2 class="card-title">‚öôÔ∏è Arduino TinkerCad - Syst√®me EPI Detection</h2>
            
            <!-- Capteurs IoT -->
            <div style="margin-bottom: 25px;">
                <h3 style="color: #667eea; font-size: 1.1em; margin-bottom: 15px;">üìä Capteurs IoT & Statistiques</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 15px; border-left: 4px solid #10b981;">
                        <div style="font-size: 0.9em; color: #999; margin-bottom: 5px;">üë∑ Travailleurs en zone</div>
                        <div style="font-size: 2em; font-weight: bold; color: #10b981;" id="workers-count">0</div>
                    </div>
                    <div style="background: rgba(249, 115, 22, 0.1); border-radius: 8px; padding: 15px; border-left: 4px solid #f97316;">
                        <div style="font-size: 0.9em; color: #999; margin-bottom: 5px;">ü™ñ Casques d√©tect√©s</div>
                        <div style="font-size: 2em; font-weight: bold; color: #f97316;" id="helmets-arduino">0</div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 15px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 0.9em; color: #999; margin-bottom: 5px;">üüß Gilets d√©tect√©s</div>
                        <div style="font-size: 2em; font-weight: bold; color: #3b82f6;" id="vests-arduino">0</div>
                    </div>
                    <div style="background: rgba(6, 182, 212, 0.1); border-radius: 8px; padding: 15px; border-left: 4px solid #06b6d4;">
                        <div style="font-size: 0.9em; color: #999; margin-bottom: 5px;">üëì Lunettes d√©tect√©es</div>
                        <div style="font-size: 2em; font-weight: bold; color: #06b6d4;" id="glasses-arduino">0</div>
                    </div>
                    <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 15px; border-left: 4px solid #8b5cf6;">
                        <div style="font-size: 0.9em; color: #999; margin-bottom: 5px;">üìä Taux de conformit√©</div>
                        <div style="font-size: 2em; font-weight: bold; color: #8b5cf6;" id="compliance-rate-arduino">0%</div>
                    </div>
                </div>
            </div>

            <!-- LED Status Display -->
            <div>
                <h3 style="color: #667eea; font-size: 1.1em; margin-bottom: 15px;">üí° √âtat des LEDs & Buzzer Arduino</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="background: rgba(16, 185, 129, 0.15); border-radius: 8px; padding: 20px; border: 2px solid #10b981; text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 10px;" id="led-green-indicator">‚ö´</div>
                        <div style="font-size: 0.95em; color: #999; margin-bottom: 5px;">üü¢ LED Verte</div>
                        <div style="font-size: 0.85em; color: #666;">(Conformit√© ‚â• 50%)</div>
                        <div style="font-size: 0.75em; color: #999; margin-top: 8px; font-family: monospace;">Pin 4</div>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.15); border-radius: 8px; padding: 20px; border: 2px solid #ef4444; text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 10px;" id="led-red-indicator">‚ö´</div>
                        <div style="font-size: 0.95em; color: #999; margin-bottom: 5px;">üî¥ LED Rouge</div>
                        <div style="font-size: 0.85em; color: #666;">(Conforme < 50%)</div>
                        <div style="font-size: 0.75em; color: #999; margin-top: 8px; font-family: monospace;">Pin 5</div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.15); border-radius: 8px; padding: 20px; border: 2px solid #3b82f6; text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 10px;" id="buzzer-indicator">üîá</div>
                        <div style="font-size: 0.95em; color: #999; margin-bottom: 5px;">üîä Buzzer</div>
                        <div style="font-size: 0.85em; color: #666;">(Alerte active)</div>
                        <div style="font-size: 0.75em; color: #999; margin-top: 8px; font-family: monospace;">Pin 6</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: Cam√©ra & D√©tections (3 colonnes) -->
        <div class="unified-layout">
            <!-- COLONNE 1: Cam√©ra en Direct -->
            <div class="card">
                <h2 class="card-title">üìπ Flux Cam√©ra en Direct</h2>
                <div class="camera-feed" id="camera-feed">
                    <video id="video-feed" width="100%" height="100%" autoplay playsinline></video>
                    <canvas id="overlay-canvas" style="position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none;"></canvas>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" id="start-camera-btn">‚ñ∂Ô∏è D√©marrer Webcam</button>
                    <button class="btn btn-secondary" id="stop-camera-btn" disabled>‚èπÔ∏è Arr√™ter</button>
                    <button class="btn btn-secondary" id="snapshot-btn">üì∏ Capture</button>
                </div>
                <div id="camera-alerts"></div>
            </div>

            <!-- COLONNE 2: D√©tections en Temps R√©el -->
            <div class="card">
                <h2 class="card-title">üîç D√©tections en Temps R√©el</h2>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-value" id="person-count">0</div>
                        <div class="metric-label">Personnes üë§</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="helmet-count">0</div>
                        <div class="metric-label">Casques ü™ñ</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="vest-count">0</div>
                        <div class="metric-label">Gilets üüß</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="glasses-count">0</div>
                        <div class="metric-label">Lunettes üëì</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="boots-count">0</div>
                        <div class="metric-label">Bottes üë¢</div>
                    </div>
                </div>
                <h3 style="margin-top: 20px; margin-bottom: 10px; color: #667eea; font-size: 1.1em;">D√©tections R√©centes:</h3>
                <div class="detection-list" id="detections-list"></div>
            </div>

            <!-- COLONNE 3: Alertes + Stats -->
            <div>
                <!-- Section Alertes -->
                <div class="card">
                    <h2 class="card-title">‚ö†Ô∏è Alertes Actives</h2>
                    <div class="audio-controls">
                        <span>üîä Audio:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="audio-alerts" checked>
                            <span class="slider"></span>
                        </label>
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;" id="test-alert-btn">Test üîä</button>
                    </div>
                    <div id="alerts-list" class="detection-list"></div>
                    <button class="btn btn-secondary" id="clear-alerts-btn" style="width: 100%; margin-top: 10px;">üóëÔ∏è Effacer Alertes</button>
                </div>

                <!-- Section Stats -->
                <div class="card" style="margin-top: 20px;">
                    <h2 class="card-title">üìä Statistiques en Temps R√©el</h2>
                    <div class="metrics-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="metric" style="font-size: 0.9em;">
                            <div class="metric-value" style="font-size: 1.5em;" id="fps-value">0</div>
                            <div class="metric-label">FPS</div>
                        </div>
                        <div class="metric" style="font-size: 0.9em;">
                            <div class="metric-value" style="font-size: 1.5em;" id="inference-time">0ms</div>
                            <div class="metric-label">Inf√©rence</div>
                        </div>
                        <div class="metric" style="font-size: 0.9em;">
                            <div class="metric-value" style="font-size: 1.5em;" id="confidence-avg">0%</div>
                            <div class="metric-label">Confiance</div>
                        </div>
                        <div class="metric" style="font-size: 0.9em;">
                            <div class="metric-value" style="font-size: 1.2em;" id="uptime">00:00:00</div>
                            <div class="metric-label">Uptime</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 3: Code Arduino & Monitoring (Collapsible) -->
        <div class="card" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 class="card-title" style="margin: 0;">üì° Code Arduino & Monitoring</h2>
                <button id="toggle-code-section" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9em;">‚ñº Afficher</button>
            </div>
            
            <div id="code-section" style="display: none;">
                <!-- Arduino Code -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0; font-size: 1.1em; color: #667eea;">üìÑ Code Arduino (TinkerCad)</h3>
                        <button id="toggle-arduino-code" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;">üìñ Afficher Code</button>
                    </div>
                    <pre id="arduino-code-block" style="background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; max-height: 400px; overflow-y: auto; font-size: 0.85em; display: none; border: 1px solid #334155;">
                    </pre>
                </div>

                <!-- Serial Monitor -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0; font-size: 1.1em; color: #667eea;">üì° Moniteur S√©rie (Simulation)</h3>
                        <button id="clear-serial-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.9em;">üóëÔ∏è Effacer</button>
                    </div>
                    <div id="serial-monitor" style="background: #0f172a; color: #10b981; font-family: 'Courier New', monospace; padding: 12px; border-radius: 6px; max-height: 250px; overflow-y: auto; font-size: 0.9em; white-space: pre-wrap; word-break: break-word; border: 1px solid #334155;">
                        üöÄ Syst√®me de d√©tection EPI - Arduino
                        =====================================
                        ‚úÖ Syst√®me initialis√©
                        üì° En attente de d√©tections...
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 4: Footer -->
        <div class="footer" style="margin-top: 30px;">
            <p>üéØ EPI Detection Dashboard v2.0 | Syst√®me temps r√©el de d√©tection d'√©quipements de protection</p>
            <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">
                Derni√®re mise √† jour: <span id="last-update">--:--:--</span> | 
                Statut: <span id="system-status">En attente de connexion...</span>
            </p>
        </div>
    </div>
                <!-- Section Alertes -->
                <div class="card">
                    <h2 class="card-title">‚ö†Ô∏è Alertes Actives</h2>
                    <div class="audio-controls">
                        <span>üîä Audio:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="audio-alerts" checked>
                            <span class="slider"></span>
                        </label>
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;" id="test-alert-btn">Test üîä</button>
                    </div>
                    <div id="alerts-list" class="detection-list"></div>
                    <button class="btn btn-secondary" id="clear-alerts-btn" style="width: 100%; margin-top: 10px;">üóëÔ∏è Effacer Alertes</button>
                </div>

                <!-- Section Stats -->
                <div class="card" style="margin-top: 20px;">
                    <h2 class="card-title">üìä Statistiques</h2>
                    <div class="metrics-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="metric" style="font-size: 0.9em;">
                            <div class="metric-value" style="font-size: 1.5em;" id="fps-value">0</div>
                            <div class="metric-label">FPS</div>
                        </div>
                        <div class="metric" style="font-size: 0.9em;">
                            <div class="metric-value" style="font-size: 1.5em;" id="inference-time">0ms</div>
                            <div class="metric-label">Inf√©rence</div>
                        </div>
                        <div class="metric" style="font-size: 0.9em;">
                            <div class="metric-value" style="font-size: 1.5em;" id="confidence-avg">0%</div>
                            <div class="metric-label">Confiance</div>
                        </div>
                        <div class="metric" style="font-size: 0.9em;">
                            <div class="metric-value" style="font-size: 1.2em;" id="uptime">00:00:00</div>
                            <div class="metric-label">Uptime</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Hidden audio element for alerts -->
    <audio id="alert-sound" class="notification-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQIAAAAAAA==" type="audio/wav">
    </audio>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load Arduino Code -->
    <script>
        // Charger le code Arduino depuis le serveur
        async function loadArduinoCode() {
            try {
                const response = await fetch('/arduino_code/epi_detection_tinkercad.ino');
                const code = await response.text();
                const codeBlock = document.getElementById('arduino-code-block');
                if (codeBlock) {
                    codeBlock.textContent = code;
                }
            } catch (err) {
                console.log('Erreur chargement code Arduino:', err);
                const codeBlock = document.getElementById('arduino-code-block');
                if (codeBlock) {
                    codeBlock.textContent = '// Code Arduino non disponible';
                }
            }
        }
        
        // Afficher/Masquer le code Arduino
        const toggleBtn = document.getElementById('toggle-arduino-code');
        const codeBlock = document.getElementById('arduino-code-block');
        if (toggleBtn && codeBlock) {
            toggleBtn.addEventListener('click', () => {
                codeBlock.style.display = codeBlock.style.display === 'none' ? 'block' : 'none';
            });
        }
        
        // Charger le code au chargement de la page
        loadArduinoCode();
        
        // Effacer le moniteur s√©rie
        const clearSerialBtn = document.getElementById('clear-serial-btn');
        if (clearSerialBtn) {
            clearSerialBtn.addEventListener('click', () => {
                const monitor = document.getElementById('serial-monitor');
                if (monitor) {
                    monitor.textContent = 'üì° Moniteur s√©rie r√©initialis√©\n';
                }
            });
        }
        
        // Ajouter une ligne au moniteur s√©rie
        function addSerialLine(line) {
            const monitor = document.getElementById('serial-monitor');
            if (monitor) {
                const timestamp = new Date().toLocaleTimeString('fr-FR');
                monitor.textContent += `[${timestamp}] ${line}\n`;
                monitor.scrollTop = monitor.scrollHeight;
            }
        }
    </script>

    <script>
        // Charger le code Arduino depuis le serveur
        async function loadArduinoCode() {
            try {
                const response = await fetch('/arduino_code/epi_detection_tinkercad.ino');
                const code = await response.text();
                const codeBlock = document.getElementById('arduino-code-block');
                if (codeBlock) {
                    codeBlock.textContent = code;
                }
            } catch (err) {
                console.log('Erreur chargement code Arduino:', err);
                const codeBlock = document.getElementById('arduino-code-block');
                if (codeBlock) {
                    codeBlock.textContent = '// Code Arduino non disponible';
                }
            }
        }
        
        // Toggle section code Arduino
        const toggleCodeSectionBtn = document.getElementById('toggle-code-section');
        const codeSection = document.getElementById('code-section');
        if (toggleCodeSectionBtn && codeSection) {
            toggleCodeSectionBtn.addEventListener('click', () => {
                const isVisible = codeSection.style.display === 'block';
                codeSection.style.display = isVisible ? 'none' : 'block';
                toggleCodeSectionBtn.textContent = isVisible ? '‚ñº Afficher' : '‚ñ≤ Masquer';
            });
        }
        
        // Afficher/Masquer le code Arduino
        const toggleBtn = document.getElementById('toggle-arduino-code');
        const codeBlock = document.getElementById('arduino-code-block');
        if (toggleBtn && codeBlock) {
            toggleBtn.addEventListener('click', () => {
                codeBlock.style.display = codeBlock.style.display === 'none' ? 'block' : 'none';
                toggleBtn.textContent = codeBlock.style.display === 'none' ? 'üìñ Afficher Code' : 'üìñ Masquer Code';
            });
        }
        
        // Charger le code au chargement de la page
        loadArduinoCode();
        
        // Effacer le moniteur s√©rie
        const clearSerialBtn = document.getElementById('clear-serial-btn');
        if (clearSerialBtn) {
            clearSerialBtn.addEventListener('click', () => {
                const monitor = document.getElementById('serial-monitor');
                if (monitor) {
                    monitor.textContent = 'üì° Moniteur s√©rie r√©initialis√©\n';
                }
            });
        }
        
        // Ajouter une ligne au moniteur s√©rie
        function addSerialLine(line) {
            const monitor = document.getElementById('serial-monitor');
            if (monitor) {
                const timestamp = new Date().toLocaleTimeString('fr-FR');
                monitor.textContent += `[${timestamp}] ${line}\n`;
                monitor.scrollTop = monitor.scrollHeight;
            }
        }
    </script>

    <script>
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const htmlElement = document.documentElement;
        const body = document.body;

        // Charger le th√®me sauvegard√©
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
            themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
        }

        themeToggleBtn.addEventListener('click', function() {
            body.classList.toggle('light-mode');
            const isLight = body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            themeToggleBtn.innerHTML = isLight ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        });

        // ===== Charger les Vraies Donn√©es d'Entra√Ænement =====
        function loadTrainingData() {
            fetch('/api/training-results')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.results.length > 0) {
                        const latestResult = data.results[0];
                        console.log('Donn√©es d\'entra√Ænement charg√©es:', latestResult);
                        
                        // Afficher les m√©triques d'entra√Ænement
                        if (latestResult.val_accuracy) {
                            document.getElementById('confidence-avg').textContent = 
                                Math.round(latestResult.val_accuracy * 100) + '%';
                        }
                        if (latestResult.fps) {
                            document.getElementById('fps-value').textContent = latestResult.fps.toFixed(1);
                        }
                        if (latestResult.inference_time_ms) {
                            document.getElementById('inference-time').textContent = 
                                Math.round(latestResult.inference_time_ms) + 'ms';
                        }
                    }
                })
                .catch(err => console.log('Erreur chargement donn√©es:', err));
        }

        // ===== Variables Globales =====
        let cameraActive = false;
        let detectionActive = false;
        let simulationActive = false;
        let audioAlertsEnabled = true;
        let alertCount = 0;
        let detectionCount = 0;
        let startTime = Date.now();
        let stream = null;
        let detectionInterval = null;
        let isDetecting = false; // Flag pour √©viter les requ√™tes API concurrentes

        // ===== Gestion de la Webcam =====
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 480 }, height: { ideal: 360 } }, // R√©duit pour moins de donn√©es
                    audio: false 
                });
                
                const videoElement = document.getElementById('video-feed');
                videoElement.srcObject = stream;
                
                cameraActive = true;
                document.getElementById('start-camera-btn').disabled = true;
                document.getElementById('stop-camera-btn').disabled = false;
                document.getElementById('camera-feed').classList.remove('offline');
                document.getElementById('camera-status').className = 'status-indicator online';
                document.getElementById('camera-status-text').textContent = 'En ligne';
                
                addAlert('Webcam d√©marr√©e avec succ√®s ‚úÖ', 'success');
                console.log('Webcam started');
                
                // D√©marrer la boucle de d√©tection (1500ms pour √©viter saturation)
                if (detectionInterval) clearInterval(detectionInterval);
                detectionInterval = setInterval(() => {
                    if (cameraActive && !isDetecting) {
                        simulateDetections().catch(err => console.error('Erreur d√©tection:', err));
                    }
                }, 1500);
            } catch (err) {
                console.error('Erreur webcam:', err);
                addAlert(`Erreur webcam: ${err.message}`, 'danger');
                document.getElementById('camera-feed').innerHTML = `<span>Erreur: ${err.message}</span>`;
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                cameraActive = false;
                isDetecting = false;
                document.getElementById('start-camera-btn').disabled = false;
                document.getElementById('stop-camera-btn').disabled = true;
                document.getElementById('camera-feed').classList.add('offline');
                document.getElementById('camera-status').className = 'status-indicator offline';
                document.getElementById('camera-status-text').textContent = 'D√©connect√©e';
                addAlert('Webcam arr√™t√©e', 'danger');
                
                // Arr√™ter la boucle de d√©tection
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }
            }
        }
        
        // Nettoyage quand on quitte la page ou change de page
        window.addEventListener('beforeunload', function() {
            stopCamera();
            if (detectionInterval) clearInterval(detectionInterval);
            cameraActive = false;
        });
        
        // Nettoyage aussi quand la page se cache (onglet/fen√™tre ferm√©e)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopCamera();
            }
        });

        document.getElementById('start-camera-btn').addEventListener('click', startCamera);
        document.getElementById('stop-camera-btn').addEventListener('click', stopCamera);

        // Capturer une image
        document.getElementById('snapshot-btn').addEventListener('click', function() {
            const video = document.getElementById('video-feed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/jpeg');
            link.download = `capture_${new Date().getTime()}.jpg`;
            link.click();
            
            addAlert('Capture d\'√©cran sauvegard√©e üì∏', 'success');
        });

        // ===== Gestion Audio =====
        document.getElementById('audio-alerts').addEventListener('change', function() {
            audioAlertsEnabled = this.checked;
            console.log('Alertes audio:', audioAlertsEnabled ? 'Activ√©es' : 'D√©sactiv√©es');
        });

        function playAlertSound() {
            if (audioAlertsEnabled) {
                generateBeepSound(800, 200);
                setTimeout(() => generateBeepSound(1000, 200), 250);
            }
        }

        function generateBeepSound(frequency, duration) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
            } catch (e) {
                console.log('Audio context error:', e);
            }
        }

        // ===== Test Alerte =====
        document.getElementById('test-alert-btn').addEventListener('click', function() {
            playAlertSound();
            addAlert('Test Alerte Audio üîä', 'warning');
        });

        // ===== Gestion des Alertes =====
        function addAlert(message, type = 'danger') {
            const alertsDiv = document.getElementById('alerts-list');
            const alertEl = document.createElement('div');
            alertEl.className = `detection-item ${type}`;
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            alertEl.innerHTML = `
                <span>${message}</span>
                <span style="font-size: 0.8em; color: #999;">${timestamp}</span>
            `;
            alertsDiv.insertBefore(alertEl, alertsDiv.firstChild);
            
            // Limiter √† 5 alertes pour r√©duire la RAM
            while (alertsDiv.children.length > 5) {
                alertsDiv.removeChild(alertsDiv.lastChild);
            }
            
            if (type === 'danger') {
                alertCount++;
                const triggeredEl = document.getElementById('alerts-triggered');
                if (triggeredEl) triggeredEl.textContent = alertCount;
            }
        }

        document.getElementById('clear-alerts-btn').addEventListener('click', function() {
            document.getElementById('alerts-list').innerHTML = '';
        });


        // ===== Mise √† Jour du Temps =====
        setInterval(() => {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('fr-FR');
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            document.getElementById('uptime').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);

        // ===== Simulation D√©tections =====
        // Couleurs et labels pour chaque classe
        const CLASS_STYLES = {
            'helmet': { color: '#10b981', label: 'Casque' },
            'vest': { color: '#f97316', label: 'Gilet' },
            'glasses': { color: '#06b6d4', label: 'Lunettes' },
            'person': { color: '#6366f1', label: 'Personne' },
            'boots': { color: '#8b5cf6', label: 'Bottes' },
            'unknown': { color: '#ffffff', label: 'Inconnu' }
        };

        function drawDetections(detections) {
            const video = document.getElementById('video-feed');
            const canvas = document.getElementById('overlay-canvas');
            if (!canvas || !video) return;

            // Ajuster la taille du canvas au video display size
            const rect = video.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Si aucune d√©tection, rien √† dessiner
            if (!detections || detections.length === 0) return;

            // Video natural size vs displayed size
            const videoWidth = video.videoWidth || canvas.width;
            const videoHeight = video.videoHeight || canvas.height;
            const scaleX = canvas.width / videoWidth;
            const scaleY = canvas.height / videoHeight;

            detections.forEach(det => {
                // Supporter soit 'class_name' soit 'class'
                const cls = det.class_name || det.class || 'unknown';
                const bbox = det.bbox || det.box || det.bbox_xyxy || null;
                if (!bbox) return;

                // bbox attendu: [x1, y1, x2, y2]
                const x1 = bbox[0] * scaleX;
                const y1 = bbox[1] * scaleY;
                const x2 = bbox[2] * scaleX;
                const y2 = bbox[3] * scaleY;

                const w = x2 - x1;
                const h = y2 - y1;

                const style = CLASS_STYLES[cls] || CLASS_STYLES['unknown'];
                ctx.strokeStyle = style.color;
                ctx.lineWidth = Math.max(2, Math.round(Math.min(canvas.width, canvas.height) / 200));
                ctx.fillStyle = style.color;

                // Rectangle
                ctx.beginPath();
                ctx.rect(x1, y1, w, h);
                ctx.stroke();

                // Label background
                const label = `${style.label} ${(det.confidence || det.conf || 0) * 100 ? Math.round((det.confidence || det.conf || 0) * 100) + '%' : ''}`;
                ctx.font = `${Math.max(12, Math.round(canvas.height / 40))}px sans-serif`;
                const textMetrics = ctx.measureText(label);
                const pad = 6;
                const labelW = textMetrics.width + pad * 2;
                const labelH = parseInt(ctx.font, 10) + pad;

                // Draw label background (semi-transparent)
                ctx.globalAlpha = 0.85;
                ctx.fillRect(x1, Math.max(0, y1 - labelH - 4), labelW, labelH);
                ctx.globalAlpha = 1.0;

                // Draw label text
                ctx.fillStyle = '#000000';
                ctx.fillText(label, x1 + pad, Math.max(0, y1 - 6));
            });
        }
        async function simulateDetections() {
            const videoElement = document.getElementById('video-feed');
            if (!cameraActive || !videoElement || videoElement.videoWidth === 0) {
                // Arr√™ter compl√®tement la d√©tection si la cam√©ra est inactive
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }
                return;
            }
            
            // √âviter les appels API concurrents
            if (isDetecting) {
                console.log('D√©tection en cours... skipping');
                return;
            }
            
            isDetecting = true;
            
            try {
                // Capturer le frame actuel de la webcam
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                
                if (canvas.width === 0 || canvas.height === 0) {
                    console.log('Video dimensions not ready yet');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoElement, 0, 0);
                
                // Convertir le canvas en base64 JPEG avec qualit√© r√©duite (0.7 pour moins de donn√©es)
                const imageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                
                // R√©cup√©rer le mode de d√©tection s√©lectionn√©
                const detectionMode = document.getElementById('detection-mode-select').value;
                const useEnsemble = detectionMode === 'ensemble';
                
                // Envoyer √† l'API pour la vraie d√©tection
                const response = await fetch(`/api/detect?use_ensemble=${useEnsemble}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: imageBase64,
                        use_ensemble: useEnsemble
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erreur API d√©tection:', response.status, errorText);
                    addAlert(`‚ö†Ô∏è Erreur API: ${response.status}`, 'danger');
                    isDetecting = false;
                    return;
                }
                
                const result = await response.json();
                console.log('R√©ponse API:', result); // Debug
                
                if (!result.success) {
                    console.error('Erreur d√©tection:', result.error);
                    addAlert(`‚ö†Ô∏è Erreur: ${result.error}`, 'danger');
                    isDetecting = false;
                    return;
                }
                
                // Mettre √† jour l'interface avec les VRAIES d√©tections
                const detections = result.detections || [];
                const stats = result.statistics || {};
                
                // Mettre √† jour les compteurs de classes
                // Mettre √† jour les compteurs (avec v√©rification d'existence pour √©viter les erreurs JS)
                const helmetEl = document.getElementById('helmet-count');
                if (helmetEl) helmetEl.textContent = stats.with_helmet || 0;
                const vestEl = document.getElementById('vest-count');
                if (vestEl) vestEl.textContent = stats.with_vest || 0;
                const glassesEl = document.getElementById('glasses-count');
                if (glassesEl) glassesEl.textContent = stats.with_glasses || 0;
                const personEl = document.getElementById('person-count');
                if (personEl) personEl.textContent = stats.total_persons || 0;
                const bootsEl = document.getElementById('boots-count');
                if (bootsEl) bootsEl.textContent = stats.with_boots || 0;
                
                // Mettre √† jour les compteurs Arduino
                const helmetsArduinoEl = document.getElementById('helmets-arduino');
                if (helmetsArduinoEl) helmetsArduinoEl.textContent = stats.with_helmet || 0;
                const vestsArduinoEl = document.getElementById('vests-arduino');
                if (vestsArduinoEl) vestsArduinoEl.textContent = stats.with_vest || 0;
                const glassesArduinoEl = document.getElementById('glasses-arduino');
                if (glassesArduinoEl) glassesArduinoEl.textContent = stats.with_glasses || 0;
                const complianceArduinoEl = document.getElementById('compliance-rate-arduino');
                if (complianceArduinoEl) complianceArduinoEl.textContent = (stats.compliance_rate || 0).toFixed(0) + '%';
                
                // Mettre √† jour les LEDs Arduino en fonction du taux de conformit√©
                const complianceRate = stats.compliance_rate || 0;
                const ledGreenEl = document.getElementById('led-green-indicator');
                const ledRedEl = document.getElementById('led-red-indicator');
                const buzzerEl = document.getElementById('buzzer-indicator');
                
                if (stats.total_persons === 0) {
                    // Aucun travailleur: LEDs √©teintes
                    if (ledGreenEl) ledGreenEl.textContent = '‚ö´';
                    if (ledRedEl) ledRedEl.textContent = '‚ö´';
                    if (buzzerEl) buzzerEl.textContent = 'üîá';
                } else if (complianceRate >= 50) {
                    // Conformit√© ‚â• 50%: LED verte allum√©e
                    if (ledGreenEl) ledGreenEl.textContent = 'üü¢';
                    if (ledRedEl) ledRedEl.textContent = '‚ö´';
                    if (buzzerEl) buzzerEl.textContent = 'üîá';
                } else {
                    // Conformit√© < 50%: LED rouge allum√©e + buzzer
                    if (ledGreenEl) ledGreenEl.textContent = '‚ö´';
                    if (ledRedEl) ledRedEl.textContent = 'üî¥';
                    if (buzzerEl) buzzerEl.textContent = 'üîä';
                }
                
                // Mettre √† jour les statistiques
                document.getElementById('fps-value').textContent = (1000 / (stats.total_ms || 33)).toFixed(1);
                document.getElementById('inference-time').textContent = (stats.inference_ms || 0).toFixed(0) + 'ms';
                document.getElementById('confidence-avg').textContent = (stats.compliance_rate || 0).toFixed(0) + '%';
                
                // Afficher les d√©tections dans la liste
                const detectionsList = document.getElementById('detections-list');
                detectionsList.innerHTML = '';
                
                const classLabels = {
                    'helmet': 'ü™ñ Casque',
                    'vest': 'üüß Gilet',
                    'glasses': 'üëì Lunettes',
                    'person': 'üë§ Personne',
                    'boots': 'üë¢ Bottes'
                };
                
                // Limiter strictement √† 3 d√©tections pour √©conomiser la RAM
                const maxDetections = Math.min(detections.length, 3);
                for (let i = 0; i < maxDetections; i++) {
                    const det = detections[i];
                    const item = document.createElement('div');
                    const className = det.class_name || det.class || 'unknown';
                    const confidence = det.confidence || 0;
                    item.className = `detection-item ${className}`;
                    item.innerHTML = `
                        <span>${classLabels[className] || className}</span>
                        <span class="confidence">${(confidence * 100).toFixed(0)}%</span>
                    `;
                    detectionsList.appendChild(item);
                }

                // Dessiner les bo√Ætes sur le canvas overlay (limiter aussi le drawing)
                const limitedDetections = detections.slice(0, maxDetections);
                drawDetections(limitedDetections);
                
                // Envoyer les donn√©es r√©elles √† l'Arduino
                if (stats.total_persons > 0) {
                    const complianceLevel = Math.round(stats.compliance_rate || 0);
                    sendComplianceToArduino(complianceLevel);
                    
                    // Envoyer la d√©tection principale
                    if (detections.length > 0) {
                        const topDetection = detections[0];
                        const className = topDetection.class_name || topDetection.class || 'unknown';
                        const confidence = (topDetection.confidence || 0) * 100;
                        sendDetectionToArduino(className, confidence);
                    }
                }
                
                // Alerte si conformit√© basse
                if (stats.alert_type && stats.alert_type !== 'none' && stats.alert_type !== 'safe') {
                    playAlertSound();
                    addAlert(`‚ö†Ô∏è Non-conformit√© d√©tect√©e! (${stats.compliance_level || 'critique'})`, 'danger');
                }
                
                // Log pour debug
                console.log('D√©tection r√©ussie:', {
                    detections: detections.length,
                    persons: stats.total_persons,
                    helmets: stats.with_helmet,
                    compliance: stats.compliance_rate + '%'
                });
                
            } catch (error) {
                console.error('Erreur d√©tection temps r√©el:', error);
            } finally {
                isDetecting = false;
            }
        }

        // ===== Communication Arduino =====
        function sendDetectionToArduino(className, confidence) {
            const detectionMap = {
                'helmet': { helmet: true, vest: false, glasses: false },
                'vest': { helmet: false, vest: true, glasses: false },
                'glasses': { helmet: false, vest: false, glasses: true },
                'person': { helmet: false, vest: false, glasses: false },
                'boots': { helmet: false, vest: false, glasses: false }
            };
            
            const detection = detectionMap[className] || { helmet: false, vest: false, glasses: false };
            
            fetch('/api/arduino/send-detection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    helmet: detection.helmet,
                    vest: detection.vest,
                    glasses: detection.glasses,
                    confidence: parseInt(confidence)
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úì Arduino notifi√©:', data.command);
                }
            })
            .catch(err => console.log('Erreur Arduino:', err));
        }

        function sendComplianceToArduino(level) {
            fetch('/api/arduino/send-compliance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ level: level })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úì Conformit√© envoy√©e:', data.compliance + '%');
                }
            })
            .catch(err => console.log('Erreur conformit√©:', err));
        }

        // ===== Initialisation =====
        document.getElementById('detection-status').className = 'status-indicator online';
        document.getElementById('detection-status-text').textContent = 'Pr√™te';

        // Cam√©ra d√©marr√©e manuellement (pas d'autostart)
        window.addEventListener('load', function() {
            console.log('Page charg√©e, en attente de d√©marrage manuel de la webcam...');
            loadTrainingData();
        });

        console.log('Dashboard unifi√© charg√© avec succ√®s! - Cam√©ra pr√™te pour d√©marrage manuel');
    </script>
{% endblock %}

{% block scripts %}
<script>
    // ===== CLASSE ARDUINOMANAGER - GESTION AVANC√âE ARDUINO =====
    class ArduinoManager {
        constructor(port = 'COM3') {
            this.port = port;
            this.connected = false;
            this.metrics = {
                motion_detected: false,
                temperature: null,
                humidity: null,
                helmet: false,
                vest: false,
                glasses: false,
                compliance: 0,
                status: 'DISCONNECTED',
                last_update: null
            };
            this.eventStream = null;
            this.callbacks = [];
        }

        async connect() {
            try {
                const response = await fetch('/api/physical/arduino/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port: this.port })
                });
                
                const data = await response.json();
                
                if (data.status === 'ok') {
                    this.connected = true;
                    console.log('‚úÖ Arduino connect√©');
                    this.startMetricsStream();
                    return true;
                }
                
                return false;
            } catch (err) {
                console.error('Erreur connexion Arduino:', err);
                return false;
            }
        }

        async disconnect() {
            try {
                if (this.eventStream) this.eventStream.close();
                
                await fetch('/api/physical/arduino/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port: this.port })
                });
                
                this.connected = false;
                return true;
            } catch (err) {
                console.error('Erreur d√©connexion Arduino:', err);
                return false;
            }
        }

        async sendCompliance(level) {
            try {
                const response = await fetch('/api/physical/arduino/send-compliance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port: this.port, compliance: level })
                });
                return (await response.json()).status === 'ok';
            } catch (err) {
                console.error('Erreur conformit√©:', err);
                return false;
            }
        }

        async sendDetection(helmet, vest, glasses, confidence) {
            try {
                const response = await fetch('/api/physical/arduino/send-detection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port: this.port, helmet, vest, glasses, confidence })
                });
                return (await response.json()).status === 'ok';
            } catch (err) {
                console.error('Erreur d√©tection:', err);
                return false;
            }
        }

        startMetricsStream() {
            if (this.eventStream) this.eventStream.close();
            
            try {
                this.eventStream = new EventSource(`/api/physical/arduino/metrics-stream?port=${this.port}`);
                
                this.eventStream.onmessage = (event) => {
                    try {
                        this.metrics = JSON.parse(event.data);
                        this.updateUI();
                        this.callbacks.forEach(cb => cb(this.metrics));
                    } catch (err) {
                        console.error('Parse erreur:', err);
                    }
                };
                
                this.eventStream.onerror = () => {
                    this.connected = false;
                };
            } catch (err) {
                console.error('Stream erreur:', err);
            }
        }

        updateUI() {
            const compliance = this.metrics.compliance || 0;
            
            // LEDs
            const greenIndicator = document.getElementById('led-green-indicator');
            if (greenIndicator) {
                greenIndicator.textContent = compliance >= 80 ? 'üü¢' : '‚ö´';
            }
            
            const redIndicator = document.getElementById('led-red-indicator');
            if (redIndicator) {
                redIndicator.textContent = compliance < 80 ? 'üî¥' : '‚ö´';
            }
            
            const buzzerIndicator = document.getElementById('buzzer-indicator');
            if (buzzerIndicator) {
                buzzerIndicator.textContent = compliance < 60 ? 'üîä' : 'üîá';
            }
        }
    }

    const arduinoManager = new ArduinoManager('COM3');

    // ===== GESTION CONFIGURATION P√âRIPH√âRIQUES PHYSIQUES =====
    class PhysicalDeviceManager {
        constructor() {
            this.config = this.loadConfig();
            this.statusLog = document.getElementById('device-status-log');
            this.initializeListeners();
        }

        loadConfig() {
            const saved = localStorage.getItem('physicalDevicesConfig');
            return saved ? JSON.parse(saved) : {
                devices: {
                    arduino: true,
                    mqtt: false,
                    network: false,
                    bluetooth: false,
                    usb: false,
                    cloud: false
                },
                settings: {
                    arduino_port: 'COM3',
                    mqtt_broker: 'localhost:1883',
                    network_endpoint: 'http://localhost:8000/api/sensors',
                    bluetooth_device: '',
                    usb_device_id: '',
                    cloud_config: '',
                    scan_interval: 5000,
                    connection_timeout: 10,
                    reconnect_attempts: 5
                }
            };
        }

        saveConfig() {
            localStorage.setItem('physicalDevicesConfig', JSON.stringify(this.config));
        }

        initializeListeners() {
            // Toggle device config section
            document.getElementById('toggle-device-config')?.addEventListener('click', (e) => {
                const section = document.getElementById('device-config-section');
                section.style.display = section.style.display === 'none' ? 'block' : 'none';
                e.target.textContent = section.style.display === 'none' ? '‚ñ∂ Afficher' : '‚ñº Afficher';
            });

            // Apply configuration
            document.getElementById('apply-device-config')?.addEventListener('click', () => this.applyConfiguration());

            // Test devices
            document.getElementById('test-devices')?.addEventListener('click', () => this.testDevices());

            // Reset configuration
            document.getElementById('reset-device-config')?.addEventListener('click', () => this.resetConfiguration());

            // Load saved values
            this.loadUIValues();
        }

        loadUIValues() {
            // Load checkboxes
            Object.entries(this.config.devices).forEach(([device, enabled]) => {
                const checkbox = document.getElementById(`device-${device}`);
                if (checkbox) checkbox.checked = enabled;
            });

            // Load text inputs
            Object.entries(this.config.settings).forEach(([key, value]) => {
                const input = document.getElementById(key.replace('_', '-'));
                if (input) input.value = value;
            });
        }

        applyConfiguration() {
            // Save device states
            ['arduino', 'mqtt', 'network', 'bluetooth', 'usb', 'cloud'].forEach(device => {
                const checkbox = document.getElementById(`device-${device}`);
                if (checkbox) {
                    this.config.devices[device] = checkbox.checked;
                }
            });

            // Save settings
            const settingIds = ['arduino-port', 'mqtt-broker', 'network-endpoint', 'bluetooth-device', 'usb-device-id', 'cloud-config', 'scan-interval', 'connection-timeout', 'reconnect-attempts'];
            settingIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    const key = id.replace('-', '_');
                    this.config.settings[key] = input.value;
                }
            });

            this.saveConfig();
            this.logStatus('‚úÖ Configuration sauvegard√©e et appliqu√©e');
            
            // Send to backend
            this.syncWithBackend();
        }

        async testDevices() {
            this.logStatus('üß™ Test des p√©riph√©riques en cours...\n');

            const tests = [];

            if (this.config.devices.arduino) {
                tests.push(this.testArduino());
            }
            if (this.config.devices.mqtt) {
                tests.push(this.testMQTT());
            }
            if (this.config.devices.network) {
                tests.push(this.testNetwork());
            }
            if (this.config.devices.bluetooth) {
                tests.push(this.testBluetooth());
            }
            if (this.config.devices.usb) {
                tests.push(this.testUSB());
            }
            if (this.config.devices.cloud) {
                tests.push(this.testCloud());
            }

            const results = await Promise.allSettled(tests);
            
            results.forEach((result, idx) => {
                if (result.status === 'fulfilled') {
                    this.logStatus(result.value);
                } else {
                    this.logStatus(`‚ùå Erreur test ${idx}: ${result.reason}`);
                }
            });

            this.logStatus('\n‚úîÔ∏è Test termin√©');
        }

        async testArduino() {
            const port = this.config.settings.arduino_port;
            try {
                const response = await fetch('/api/physical/arduino/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port })
                });
                const data = await response.json();
                return `üîå Arduino (${port}): ${data.status === 'ok' ? '‚úÖ Connect√©' : '‚ùå Erreur'} - ${data.message || ''}`;
            } catch (err) {
                return `üîå Arduino: ‚ùå Erreur - ${err.message}`;
            }
        }

        async testMQTT() {
            const broker = this.config.settings.mqtt_broker;
            try {
                const response = await fetch('/api/physical/mqtt/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ broker })
                });
                const data = await response.json();
                return `üåê MQTT (${broker}): ${data.status === 'ok' ? '‚úÖ Connect√©' : '‚ùå Erreur'} - ${data.message || ''}`;
            } catch (err) {
                return `üåê MQTT: ‚ùå Erreur - ${err.message}`;
            }
        }

        async testNetwork() {
            const endpoint = this.config.settings.network_endpoint;
            try {
                const response = await fetch('/api/physical/network/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ endpoint })
                });
                const data = await response.json();
                return `üì° R√©seau (${endpoint}): ${data.status === 'ok' ? '‚úÖ Connect√©' : '‚ùå Erreur'} - ${data.message || ''}`;
            } catch (err) {
                return `üì° R√©seau: ‚ùå Erreur - ${err.message}`;
            }
        }

        async testBluetooth() {
            return `üîµ Bluetooth: ‚è≥ Test en attente (Web Bluetooth API)`;
        }

        async testUSB() {
            return `üîå USB: ‚è≥ Test en attente (WebUSB API)`;
        }

        async testCloud() {
            return `‚òÅÔ∏è Cloud: ‚è≥ Test en attente (v√©rification API)`;
        }

        resetConfiguration() {
            if (confirm('√ätes-vous s√ªr? Cette action r√©initialisera tous les param√®tres.')) {
                localStorage.removeItem('physicalDevicesConfig');
                this.config = this.loadConfig();
                this.loadUIValues();
                this.logStatus('üîÑ Configuration r√©initialis√©e');
            }
        }

        async syncWithBackend() {
            try {
                const response = await fetch('/api/physical/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config)
                });
                const data = await response.json();
                this.logStatus(`\nüì§ Synchronisation backend: ${data.status === 'ok' ? '‚úÖ' : '‚ùå'}`);
            } catch (err) {
                console.warn('Sync error:', err);
            }
        }

        logStatus(message) {
            const log = document.getElementById('device-status-log');
            if (log) {
                const timestamp = new Date().toLocaleTimeString();
                log.textContent = `[${timestamp}] ${message}\n` + log.textContent;
                // Keep only last 50 lines
                const lines = log.textContent.split('\n');
                if (lines.length > 50) {
                    log.textContent = lines.slice(0, 50).join('\n');
                }
            }
        }
    }

    // Initialize physical device manager
    const deviceManager = new PhysicalDeviceManager();

    // ===== SOCKET.IO CLIENT FOR IoT / SIMULATOR UPDATES =====
    try {
        const socket = io();

        socket.on('connect', () => {
            console.log('Socket.IO connected');
        });

        socket.on('disconnect', () => {
            console.log('Socket.IO disconnected');
        });

        socket.on('iot_update', (data) => {
            console.log('iot_update', data);
            const sensors = data.sensors || {};
            // Update temp and humidity elements if present
            const tempEl = document.getElementById('temp-1');
            const humEl = document.getElementById('humidity-2');
            if (sensors.temp !== undefined && tempEl) tempEl.textContent = sensors.temp + '¬∞C';
            if (sensors.humidity !== undefined && humEl) humEl.textContent = sensors.humidity + '%';

            // Update Arduino sensor display
            if (sensors.workers !== undefined) {
                const workersEl = document.getElementById('workers-count');
                if (workersEl) workersEl.textContent = sensors.workers;
                addSerialLine(`üë∑ Travailleurs en zone: ${sensors.workers}`);
            }
            if (sensors.helmets !== undefined) {
                const helmetsEl = document.getElementById('helmets-arduino');
                if (helmetsEl) helmetsEl.textContent = sensors.helmets;
            }
            if (sensors.vests !== undefined) {
                const vestsEl = document.getElementById('vests-arduino');
                if (vestsEl) vestsEl.textContent = sensors.vests;
            }
            if (sensors.compliance_rate !== undefined) {
                const compEl = document.getElementById('compliance-rate-arduino');
                if (compEl) compEl.textContent = sensors.compliance_rate + '%';
            }

            // Motion
            if (sensors.motion) {
                const alertsList = document.getElementById('alerts-list');
                if (alertsList) {
                    const div = document.createElement('div');
                    div.className = 'detection-item';
                    div.innerHTML = `<div><strong>Mouvement d√©tect√©</strong></div><div style="font-size:0.9em;opacity:0.8">${new Date().toLocaleTimeString()}</div>`;
                    alertsList.prepend(div);
                }
                // flash device card
                const device = document.getElementById('device-1');
                if (device) {
                    device.classList.add('active');
                    setTimeout(() => device.classList.remove('active'), 2500);
                }
                addSerialLine('MOTION_DETECTED');
            }
        });

        socket.on('motion', (data) => {
            console.log('motion event', data);
            const alertsList = document.getElementById('alerts-list');
            if (alertsList) {
                const div = document.createElement('div');
                div.className = 'detection-item';
                div.innerHTML = `<div><strong>Mouvement (serial)</strong></div><div style="font-size:0.9em;opacity:0.8">${new Date().toLocaleTimeString()}</div>`;
                alertsList.prepend(div);
            }
            addSerialLine('üë∑ Mouvement d√©tect√© en zone');
        });

        socket.on('serial_line', (data) => {
            console.log('serial_line', data);
            const container = document.getElementById('camera-alerts') || document.getElementById('alerts-list');
            if (container) {
                const p = document.createElement('div');
                p.className = 'detection-item';
                p.textContent = `[${new Date().toLocaleTimeString()}] ${data.line || JSON.stringify(data)}`;
                container.prepend(p);
            }
            // Add to serial monitor
            const line = data.line || JSON.stringify(data);
            addSerialLine(line);
            
            // Parse JSON serial output if available
            if (line.startsWith('{')) {
                try {
                    const json = JSON.parse(line);
                    const workersEl = document.getElementById('workers-count');
                    const helmetsEl = document.getElementById('helmets-arduino');
                    const vestsEl = document.getElementById('vests-arduino');
                    const compEl = document.getElementById('compliance-rate-arduino');
                    
                    if (json.workers !== undefined && workersEl) workersEl.textContent = json.workers;
                    if (json.helmets !== undefined && helmetsEl) helmetsEl.textContent = json.helmets;
                    if (json.vests !== undefined && vestsEl) vestsEl.textContent = json.vests;
                    if (json.compliance_rate !== undefined && compEl) compEl.textContent = json.compliance_rate + '%';
                } catch (e) {
                    // Not JSON, ignore
                }
            }
        });

        socket.on('led_status', (data) => {
            console.log('led_status', data);
            // optional: update UI led indicators
            const status = data.state ? 'allum√©e' : '√©teinte';
            addSerialLine(`üí° LED ${data.led || '?'} ${status}`);
        });
    } catch (err) {
        console.warn('Socket.IO client init failed:', err);
    }
</script>
{% endblock %}
